<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¯ãƒ¼ãƒ‰ã‚¦ãƒ«ãƒ• ğŸº</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room@latest/dist/skyway_room.js"></script>
    <style>
        :root {
            --primary: #FFD93D; --secondary: #6BCB77; --accent: #FF6B6B;
            --bg: #FFF9CA; --text: #4D4D4D; --white: #ffffff;
        }
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .page { position: absolute; width: 90%; max-width: 450px; padding: 30px; background: var(--white); border-radius: 30px; box-shadow: 0 10px 0 #E6D5A9; opacity: 0; transform: translateY(30px) scale(0.9); pointer-events: none; transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1); box-sizing: border-box; max-height: 90vh; overflow-y: auto; }
        .page.active { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
        .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: 800; cursor: pointer; transition: 0.2s; text-align: center; box-sizing: border-box; }
        .btn-main { background: var(--primary); color: #856600; box-shadow: 0 6px 0 #D4B42E; }
        .btn-sub { background: var(--secondary); color: var(--white); box-shadow: 0 6px 0 #4FA659; }
        .btn-accent { background: var(--accent); color: var(--white); box-shadow: 0 6px 0 #D14D4D; }
        .btn:disabled { background: #ccc; box-shadow: 0 6px 0 #999; cursor: not-allowed; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 3px solid var(--primary); border-radius: 15px; font-family: inherit; font-size: 1rem; box-sizing: border-box; background: #FFFBEB; }
        .room-id-display { background: #eee; padding: 10px; border-radius: 15px; font-size: 1.5rem; text-align: center; letter-spacing: 3px; margin-bottom: 20px; font-weight: 800; }
        .user-list { padding: 0; }
        .user-list li { background: #F3F4F6; margin: 8px 0; padding: 12px 20px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; list-style: none; }
        .timer-display { font-size: 4rem; text-align: center; color: var(--accent); text-shadow: 3px 3px 0 #FFD93D; margin: 10px 0; }
        .word-card { background: var(--primary); padding: 25px; border-radius: 25px; text-align: center; font-size: 2rem; margin: 20px 0; border: 4px dashed #856600; }
        .mic-controls { display: flex; flex-direction: column; align-items: center; margin-bottom: 15px; }
        .btn-mic { width: 60px; height: 60px; border-radius: 30px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; }
        #voice-status { font-size: 0.8rem; margin-top: 5px; color: #888; }
    </style>
</head>
<body>

    <div id="page-home" class="page active">
        <h1>ğŸº Word Wolf</h1>
        <input type="text" id="input-nickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼" maxlength="8">
        <button class="btn btn-main" onclick="handleCreateRoom()">éƒ¨å±‹ã‚’ä½œã‚‹ âœ¨</button>
        <div style="text-align:center; margin:10px; color:#aaa;">ãƒ¼ãƒ¼ ã¾ãŸã¯ ãƒ¼ãƒ¼</div>
        <input type="text" id="input-room-id" placeholder="5æ¡ã®ã‚³ãƒ¼ãƒ‰" maxlength="5">
        <button class="btn btn-sub" onclick="handleJoinRoom()">å‚åŠ ã™ã‚‹ ğŸšª</button>
    </div>

    <div id="page-lobby" class="page">
        <h1>å¾…æ©Ÿãƒ­ãƒ“ãƒ¼ ğŸ•’</h1>
        <div class="room-id-display" id="display-room-id">-----</div>
        
        <div class="mic-controls">
            <button id="btn-start-voice" class="btn btn-sub" onclick="manualInitVoice()">ğŸ¤ ãƒœã‚¤ã‚¹ã‚’é–‹å§‹ã™ã‚‹</button>
            <button id="btn-mic-lobby" class="btn btn-sub btn-mic" onclick="toggleMic()" style="display:none;">ğŸ™ï¸</button>
            <div id="voice-status">ãƒœã‚¤ã‚¹æœªæ¥ç¶š</div>
        </div>

        <ul id="lobby-player-list" class="user-list"></ul>
        <div id="host-controls" style="display:none;" class="setting-box">
            <button class="btn btn-accent" onclick="handleStartGame()">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ğŸš€</button>
        </div>
        <div id="guest-msg" style="text-align:center; color:#888;">ãƒ›ã‚¹ãƒˆã®é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
    </div>

    <div id="page-game" class="page">
        <h1>ã‚ãªãŸã®ãŠé¡Œ ğŸ¤«</h1>
        <div class="word-card" id="display-my-word">...</div>
        <div class="timer-display" id="display-timer">05:00</div>
        <div class="mic-controls">
            <button id="btn-mic-game" class="btn btn-sub btn-mic" onclick="toggleMic()">ğŸ™ï¸</button>
        </div>
        <button class="btn btn-main" onclick="handleGoToVote()">è©±ã—åˆã„çµ‚äº† âœ‹</button>
    </div>

    <div id="page-vote" class="page">
        <h1>æŠ•ç¥¨ã‚¿ã‚¤ãƒ  ğŸ—³ï¸</h1>
        <button class="btn btn-accent" id="btn-sudden-death" onclick="handleSuddenDeath()">âš¡ ã‚µãƒ‰ãƒ³ãƒ‡ã‚¹ (æ®‹ã‚Š1åˆ†è¿½åŠ )</button>
        <div id="vote-container" style="margin-top:20px;"></div>
    </div>

    <div id="page-result" class="page">
        <h1>çµæœç™ºè¡¨ï¼ğŸŠ</h1>
        <div id="result-info" style="text-align:center; font-size:1.2rem; margin-bottom:20px;"></div>
        <ul id="result-details" class="user-list"></ul>
        <button class="btn btn-main" onclick="handleRestart()">ã‚‚ã†ä¸€åº¦éŠã¶ ğŸ”„</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, runTransaction, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAbZPrLSIygyIABnUGAHOigM9QmXdGRa8g",
            authDomain: "othello-hrmk.firebaseapp.com",
            projectId: "othello-hrmk",
            storageBucket: "othello-hrmk.firebasestorage.app",
            messagingSenderId: "804527745152",
            appId: "1:804527745152:web:0ab51db1cc348000801e65"
        };
        const SKYWAY_APP_ID = "86266f8a-a0de-449d-b00e-6639c2659542"; 

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app, "https://othello-hrmk-default-rtdb.asia-southeast1.firebasedatabase.app");

        const THEMES = { "ALL": [["ã‚«ãƒ•ã‚§ãƒ©ãƒ†", "ã‚«ãƒ•ã‚§ã‚ªãƒ¬"], ["ãƒ‘ãƒ³ã‚±ãƒ¼ã‚­", "ãƒ›ãƒƒãƒˆã‚±ãƒ¼ã‚­"], ["é†¤æ²¹", "ã‚ã‚“ã¤ã‚†"], ["ãƒ©ãƒ¼ãƒ¡ãƒ³", "ã¤ã‘éºº"], ["ä¸€ç›®æƒšã‚Œ", "ç‰‡æ€ã„"]] };
        let state = { roomId: "", myId: "", nickname: "", isHost: false, timerInterval: null };
        let audioPublication = null;

        window.showPage = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            setTimeout(() => document.getElementById(id).classList.add('active'), 50);
        };

        window.manualInitVoice = async () => {
            const status = document.getElementById('voice-status');
            const btnStart = document.getElementById('btn-start-voice');
            
            // window.skyway_room ã‚’ç›´æ¥ç¢ºèªã™ã‚‹
            if (!window.skyway_room) {
                status.innerText = "SkyWayã‚’èª­ã¿è¾¼ã¿ä¸­...ã‚‚ã†ä¸€åº¦æŠ¼ã—ã¦ã­ï¼";
                return;
            }

            status.innerText = "ãƒã‚¤ã‚¯ã‚’æ¥ç¶šä¸­...";
            btnStart.disabled = true;

            try {
                const { SkyWayContext, SkyWayRoom, SkyWayStreamFactory } = window.skyway_room;
                // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã‚ãšAppIDã®ã¿ã§ç¹‹ãè¨­å®šï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§èªè¨¼OFFã«ã™ã‚‹å¿…è¦ã‚ã‚Šï¼‰
                const context = await SkyWayContext.Create(SKYWAY_APP_ID);
                const room = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: state.roomId });
                const member = await room.join();
                
                const { audio } = await SkyWayStreamFactory.createMicrophoneAudioAndCameraStream();
                audioPublication = await member.publish(audio);
                
                room.onPublicationsByAnyMemberAdded.add(({ publication }) => {
                    if (publication.contentType === 'audio' && publication.publisherId !== member.id) {
                        member.subscribe(publication).then(({ stream }) => {
                            const audioEl = document.createElement('audio');
                            audioEl.srcObject = new MediaStream([stream.track]);
                            audioEl.autoplay = true;
                            document.body.appendChild(audioEl);
                        });
                    }
                });

                btnStart.style.display = "none";
                document.getElementById('btn-mic-lobby').style.display = "flex";
                status.innerText = "ãƒœã‚¤ã‚¹æ¥ç¶šå®Œäº†ï¼ ğŸ™ï¸";
                status.style.color = "#6BCB77";
            } catch (e) { 
                console.error("SkyWay Error:", e);
                status.innerText = "ã‚¨ãƒ©ãƒ¼: " + e.message;
                btnStart.disabled = false;
            }
        };

        window.toggleMic = async () => {
            if (!audioPublication) return;
            const lobbyBtn = document.getElementById('btn-mic-lobby');
            const gameBtn = document.getElementById('btn-mic-game');
            if (audioPublication.state === 'enabled') {
                await audioPublication.disable();
                [lobbyBtn, gameBtn].forEach(b => { b.innerText = "ğŸ”‡"; b.style.background = "#FF6B6B"; });
            } else {
                await audioPublication.enable();
                [lobbyBtn, gameBtn].forEach(b => { b.innerText = "ğŸ™ï¸"; b.style.background = "#6BCB77"; });
            }
        };

        window.handleCreateRoom = async () => {
            const nick = document.getElementById('input-nickname').value || "ã‚²ã‚¹ãƒˆ";
            const rid = Math.random().toString(36).substring(2, 7).toUpperCase();
            state = { ...state, roomId: rid, myId: "p_"+Date.now(), nickname: nick, isHost: true };
            try {
                await set(ref(db, 'rooms/' + rid), {
                    status: 'waiting', timer: 300, hostId: state.myId,
                    players: { [state.myId]: { name: nick, role: '', word: '', vote: '' } }
                });
                onDisconnect(ref(db, `rooms/${rid}/players/${state.myId}`)).remove();
                listenToRoom(rid);
                showPage('page-lobby');
            } catch (e) { alert("Firebaseã‚¨ãƒ©ãƒ¼"); }
        };

        window.handleJoinRoom = async () => {
            const rid = document.getElementById('input-room-id').value.toUpperCase();
            const nick = document.getElementById('input-nickname').value || "ã‚²ã‚¹ãƒˆ";
            if(rid.length !== 5) return;
            state = { ...state, roomId: rid, myId: "p_"+Date.now(), nickname: nick, isHost: false };
            try {
                await update(ref(db, `rooms/${rid}/players/${state.myId}`), { name: nick, role: '', word: '', vote: '' });
                onDisconnect(ref(db, `rooms/${rid}/players/${state.myId}`)).remove();
                listenToRoom(rid);
                showPage('page-lobby');
            } catch (e) { alert("éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); }
        };

        function listenToRoom(rid) {
            document.getElementById('display-room-id').innerText = rid;
            onValue(ref(db, 'rooms/' + rid), (snap) => {
                const data = snap.val();
                if(!data) return;
                const list = document.getElementById('lobby-player-list');
                list.innerHTML = Object.values(data.players || {}).map(p => `<li>${p.name}</li>`).join('');
                document.getElementById('host-controls').style.display = (state.isHost && data.status === 'waiting') ? 'block' : 'none';
                document.getElementById('guest-msg').style.display = state.isHost ? 'none' : 'block';
                const m = Math.floor(data.timer / 60); const s = data.timer % 60;
                document.getElementById('display-timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                
                if(data.status === 'playing' && !document.getElementById('page-game').classList.contains('active')) {
                    document.getElementById('display-my-word').innerText = data.players[state.myId]?.word || "...";
                    showPage('page-game');
                    if(state.isHost) startTimer(rid);
                }
                if(data.status === 'playing' && document.getElementById('page-vote').classList.contains('active')) {
                    showPage('page-game');
                }
                if(data.status === 'voting' && document.getElementById('page-game').classList.contains('active')) {
                    setupVoteUI(data.players);
                    showPage('page-vote');
                }
                if(data.status === 'result') showResult(data);
            });
        }

        function startTimer(rid) {
            if(state.timerInterval) clearInterval(state.timerInterval);
            state.timerInterval = setInterval(() => {
                runTransaction(ref(db, `rooms/${rid}/timer`), (t) => {
                    if(t <= 0) { update(ref(db, `rooms/${rid}`), { status: 'voting' }); clearInterval(state.timerInterval); return 0; }
                    return t - 1;
                });
            }, 1000);
        }

        window.handleStartGame = () => {
            const pair = THEMES.ALL[Math.floor(Math.random() * THEMES.ALL.length)];
            const words = Math.random() > 0.5 ? [pair[0], pair[1]] : [pair[1], pair[0]];
            onValue(ref(db, `rooms/${state.roomId}/players`), (snap) => {
                const players = snap.val();
                const ids = Object.keys(players);
                const shuffled = ids.sort(() => 0.5 - Math.random());
                const updates = { status: 'playing', timer: 300 };
                ids.forEach((id, i) => {
                    const isWolf = i === 0;
                    updates[`/players/${id}/role`] = isWolf ? 'wolf' : 'citizen';
                    updates[`/players/${id}/word`] = isWolf ? words[1] : words[0];
                    updates[`/players/${id}/vote`] = '';
                });
                update(ref(db, `rooms/${state.roomId}`), updates);
            }, { onlyOnce: true });
        };

        window.handleSuddenDeath = () => {
            update(ref(db, `rooms/${state.roomId}`), { status: 'playing', timer: 60 });
            if(state.isHost) startTimer(state.roomId);
        };
        
        window.handleGoToVote = () => update(ref(db, `rooms/${state.roomId}`), { status: 'voting' });

        function setupVoteUI(players) {
            const container = document.getElementById('vote-container');
            container.innerHTML = Object.entries(players).filter(([id]) => id !== state.myId).map(([id, p]) => `
                <div class="btn btn-sub" onclick="castVote('${id}')">${p.name}</div>
            `).join('');
        }

        window.castVote = (tid) => {
            update(ref(db, `rooms/${state.roomId}/players/${state.myId}`), { vote: tid });
            onValue(ref(db, `rooms/${state.roomId}/players`), (snap) => {
                if(Object.values(snap.val()).every(p => p.vote !== "")) update(ref(db, `rooms/${state.roomId}`), { status: 'result' });
            }, { onlyOnce: true });
        };

        function showResult(data) {
            const wolf = Object.values(data.players).find(p => p.role === 'wolf')?.name;
            document.getElementById('result-info').innerHTML = `äººç‹¼ã¯ <b>${wolf}</b> ã§ã—ãŸï¼`;
            document.getElementById('result-details').innerHTML = Object.values(data.players).map(p => `<li>${p.name} [${p.role === 'wolf' ? 'äººç‹¼' : 'å¸‚æ°‘'}]</li>`).join('');
            showPage('page-result');
        }

        window.handleRestart = () => {
            if(state.isHost) update(ref(db, `rooms/${state.roomId}`), { status: 'waiting', timer: 300 });
            showPage('page-lobby');
        };
    </script>
</body>
</html>
