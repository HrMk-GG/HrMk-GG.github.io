<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¯ãƒ¼ãƒ‰ã‚¦ãƒ«ãƒ• ğŸº V1.2.0 (Full Custom)</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FFD93D; --secondary: #6BCB77; --accent: #FF6B6B;
            --bg: #FFF9CA; --text: #4D4D4D; --white: #ffffff;
        }
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        
        .version-badge {
            position: fixed; top: 15px; left: 15px;
            background: rgba(0, 0, 0, 0.08); padding: 5px 12px; border-radius: 20px;
            font-size: 0.75rem; font-weight: 800; color: #777; z-index: 1000;
            pointer-events: none; backdrop-filter: blur(4px);
        }

        .page { position: absolute; width: 90%; max-width: 450px; padding: 25px; background: var(--white); border-radius: 30px; box-shadow: 0 10px 0 #E6D5A9; opacity: 0; transform: translateY(30px) scale(0.9); pointer-events: none; transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1); box-sizing: border-box; max-height: 95vh; overflow-y: auto; }
        .page.active { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
        
        .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: 800; cursor: pointer; transition: 0.2s; text-align: center; box-sizing: border-box; }
        .btn-main { background: var(--primary); color: #856600; box-shadow: 0 6px 0 #D4B42E; }
        .btn-sub { background: var(--secondary); color: var(--white); box-shadow: 0 6px 0 #4FA659; }
        .btn-accent { background: var(--accent); color: var(--white); box-shadow: 0 6px 0 #D14D4D; }
        .btn:active { transform: translateY(3px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 3px solid var(--primary); border-radius: 15px; font-family: inherit; font-size: 1rem; box-sizing: border-box; background: #FFFBEB; font-weight: 800; color: var(--text); }
        .room-id-display { background: #eee; padding: 15px; border-radius: 15px; font-size: 1.8rem; text-align: center; letter-spacing: 5px; margin-bottom: 5px; font-weight: 800; color: #555; cursor: pointer; position: relative; }
        .room-id-display::after { content: "ã‚¿ãƒƒãƒ—ã§æ‹›å¾…URLã‚³ãƒ”ãƒ¼"; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); font-size: 0.6rem; color: #aaa; letter-spacing: 0; }
        
        .timer-display { font-size: 3.5rem; text-align: center; color: var(--accent); text-shadow: 3px 3px 0 #FFD93D; margin: 5px 0; }
        .word-card { background: var(--primary); padding: 20px; border-radius: 25px; text-align: center; font-size: 1.6rem; margin: 10px 0; border: 4px dashed #856600; line-height: 1.4; }
        
        .setting-item { margin: 10px 0; padding: 8px; border-radius: 15px; background: #f9f9f9; border: 2px solid #eee; }
        .setting-label { font-size: 0.8rem; font-weight: 800; color: #666; margin-bottom: 4px; display: block; }

        .topic-area { background: #fdfdfd; padding: 15px; border-radius: 20px; margin: 15px 0; border: 3px solid var(--primary); }
        .topic-btns { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
        .btn-topic { width: 50px; height: 50px; border-radius: 15px; border: none; font-size: 1.2rem; font-weight: 800; cursor: pointer; box-shadow: 0 4px 0 #bbb; transition: 0.1s; }
        .btn-topic:active { transform: translateY(2px); box-shadow: 0 2px 0 #bbb; }
        .btn-t1 { background: #FF9EAA; color: white; }
        .btn-t2 { background: #A0E9FF; color: #007799; }
        .btn-t3 { background: #B6EA6D; color: #3E5E00; }
        #display-topic { font-size: 0.95rem; text-align: center; color: #444; min-height: 3em; display: flex; align-items: center; justify-content: center; font-weight: 800; padding: 5px; background: #fff; border-radius: 10px; }

        #voice-overlay { position: fixed; top: 20px; right: 20px; display: flex; flex-direction: column; align-items: flex-end; z-index: 1000; pointer-events: none; }
        .voice-user { background: rgba(0,0,0,0.1); color: #888; padding: 8px 15px; border-radius: 20px; margin-bottom: 5px; font-weight: 800; font-size: 0.8rem; }
        .voice-user.speaking { background: var(--secondary); color: white; transform: scale(1.1); animation: bounce 0.4s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-3px); } }
        
        .mic-controls { display: flex; flex-direction: column; align-items: center; margin: 10px 0; }
        .btn-mic { width: 55px; height: 55px; border-radius: 30px; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; }
        
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 25px; border-radius: 50px; font-size: 0.9rem; opacity: 0; transition: 0.5s; z-index: 2000; }
    </style>
</head>
<body>
    <div class="version-badge" id="app-version">V1.2.0</div>
    <div id="voice-overlay"></div>
    <div id="toast">ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆï¼ğŸ”—</div>

    <div id="page-home" class="page active">
        <h1>ğŸº Word Wolf</h1>
        <input type="text" id="input-nickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼" maxlength="8">
        <button class="btn btn-main" onclick="handleCreateRoom()">éƒ¨å±‹ã‚’ä½œã‚‹ âœ¨</button>
        <div style="text-align:center; margin:10px; color:#aaa;">ãƒ¼ãƒ¼ ã¾ãŸã¯ ãƒ¼ãƒ¼</div>
        <input type="text" id="input-room-id" placeholder="5æ¡ã®ã‚³ãƒ¼ãƒ‰" maxlength="5">
        <button class="btn btn-sub" onclick="handleJoinRoom()">å‚åŠ ã™ã‚‹ ğŸšª</button>
    </div>

    <div id="page-lobby" class="page">
        <h1>å¾…æ©Ÿãƒ­ãƒ“ãƒ¼ ğŸ•’</h1>
        <div class="room-id-display" id="display-room-id" onclick="copyInviteURL()">-----</div>
        <div id="host-settings" style="display:none;">
            <div class="setting-item">
                <span class="setting-label">ãƒ†ãƒ¼ãƒï¼š</span>
                <select id="select-genre">
                    <option value="food">ğŸ” é£²é£Ÿãƒ»ã‚°ãƒ«ãƒ¡</option>
                    <option value="love">ğŸ’– æ‹æ„›ãƒ»çµå©š</option>
                    <option value="play">ğŸ® éŠã³ãƒ»è¶£å‘³</option>
                    <option value="school">ğŸ« å­¦æ ¡ãƒ»ä»•äº‹</option>
                    <option value="life">ğŸ  ç”Ÿæ´»ãƒ»ç¿’æ…£</option>
                    <option value="place">ğŸ—ºï¸ å ´æ‰€ãƒ»æ–½è¨­</option>
                    <option value="emotion">ğŸ¤” æ„Ÿæƒ…ãƒ»æŠ½è±¡çš„</option>
                    <option value="random">ğŸ² å…¨æ··ãœãƒ©ãƒ³ãƒ€ãƒ </option>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <div class="setting-item" style="flex: 1;">
                    <span class="setting-label">äººç‹¼ï¼š</span>
                    <select id="select-wolf-count">
                        <option value="1">ğŸº 1äºº</option>
                        <option value="2">ğŸºğŸº 2äºº</option>
                    </select>
                </div>
                <div class="setting-item" style="flex: 1;">
                    <span class="setting-label">æ™‚é–“ï¼š</span>
                    <select id="select-timer">
                        <option value="180">3åˆ†</option>
                        <option value="300" selected>5åˆ†</option>
                        <option value="420">7åˆ†</option>
                        <option value="600">10åˆ†</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-accent" onclick="handleStartGame()">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ğŸš€</button>
        </div>
        <div id="guest-msg" style="text-align:center; color:#888; margin: 20px 0;">ãƒ›ã‚¹ãƒˆã®é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
        <div class="mic-controls">
            <button id="btn-start-voice" class="btn btn-sub" onclick="initSimpleVoice()">ğŸ¤ ãƒã‚¤ã‚¯ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
            <button id="btn-mic-lobby" class="btn btn-sub btn-mic" onclick="toggleMic()" style="display:none;">ğŸ™ï¸</button>
        </div>
    </div>

    <div id="page-game" class="page">
        <h1>ã‚ãªãŸã®ãŠé¡Œ ğŸ¤«</h1>
        <div class="word-card" id="display-my-word">...</div>
        <div class="topic-area">
            <div class="topic-btns">
                <button class="btn-topic btn-t1" onclick="sendTopicRequest(1)">â‘ </button>
                <button class="btn-topic btn-t2" onclick="sendTopicRequest(2)">â‘¡</button>
                <button class="btn-topic btn-t3" onclick="sendTopicRequest(3)">â‘¢</button>
            </div>
            <div id="display-topic">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨è©±é¡ŒãŒåŒæœŸã•ã‚Œã‚‹ã‚ˆï¼</div>
        </div>
        <div class="timer-display" id="display-timer">--:--</div>
        <div class="mic-controls"><button id="btn-mic-game" class="btn btn-sub btn-mic" onclick="toggleMic()">ğŸ™ï¸</button></div>
        <button class="btn btn-main" onclick="handleGoToVote()">è©±ã—åˆã„çµ‚äº† âœ‹</button>
    </div>

    <div id="page-vote" class="page">
        <h1>æŠ•ç¥¨ã‚¿ã‚¤ãƒ  ğŸ—³ï¸</h1>
        <div id="vote-container" style="margin-top:20px;"></div>
    </div>

    <div id="page-result" class="page">
        <h1>çµæœç™ºè¡¨ï¼ğŸŠ</h1>
        <div id="result-info" style="text-align:center; font-size:1.4rem; margin-bottom:20px;"></div>
        <button class="btn btn-main" onclick="handleRestart()">ã‚‚ã†ä¸€åº¦éŠã¶ ğŸ”„</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, runTransaction, onDisconnect, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAbZPrLSIygyIABnUGAHOigM9QmXdGRa8g",
            authDomain: "othello-hrmk.firebaseapp.com",
            projectId: "othello-hrmk",
            storageBucket: "othello-hrmk.firebasestorage.app",
            messagingSenderId: "804527745152",
            appId: "1:804527745152:web:0ab51db1cc348000801e65"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app, "https://othello-hrmk-default-rtdb.asia-southeast1.firebasedatabase.app");

        let state = { roomId: "", myId: "", nickname: "", isHost: false, timerInterval: null };
        let localStream = null;
        let peers = {};
        let audioContext = null;

        // --- ãŠé¡Œãƒ‡ãƒ¼ã‚¿ ---
        const THEMES = {
            food: { classic: [["ã—ã‚‡ã†ã‚†", "ã‚ã‚“ã¤ã‚†"], ["ã†ã©ã‚“", "ãã°"], ["ãƒãƒ¨ãƒãƒ¼ã‚º", "ã‚±ãƒãƒ£ãƒƒãƒ—"], ["ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰", "ãƒ¢ã‚¹ãƒãƒ¼ã‚¬ãƒ¼"], ["ã‚³ãƒ¼ãƒ’ãƒ¼", "ç´…èŒ¶"], ["ãƒªãƒ³ã‚´", "æ¢¨"], ["ãŠã«ãã‚Š", "ãƒ‘ãƒ³"]], human: [["åé£ŸãŒæ¿€ã—ãã†ãªäºº", "é£Ÿã¸ã®ã“ã ã‚ã‚ŠãŒå¼·ã™ãã‚‹äºº"], ["è‡ªç‚ŠãŒå®Œç’§ãã†ãªäºº", "æ¯æ—¥å¤–é£Ÿã—ã¦ãã†ãªäºº"], ["ãƒãƒ¨ãƒ©ãƒ¼ãã†ãªäºº", "æ¿€è¾›å¥½ããã†ãªäºº"]] },
            love: { classic: [["æ‹äºº", "çµå©šç›¸æ‰‹"], ["ãƒ‡ãƒ¼ãƒˆ", "åŒæ£²"], ["å‘Šç™½", "ãƒ—ãƒ­ãƒãƒ¼ã‚º"], ["æ‰‹æ–™ç†", "å¤–é£Ÿãƒ‡ãƒ¼ãƒˆ"], ["éŠåœ’åœ°", "æ˜ ç”»é¤¨"], ["ã‚µãƒ—ãƒ©ã‚¤ã‚º", "å®‰å®šã—ãŸæ—¥å¸¸"], ["ä¸€ç›®æƒšã‚Œ", "å¾ã€…ã«å¥½ãã«ãªã‚‹"]], human: [["æµ®æ°—ã—ãã†ãªäºº", "å«‰å¦¬æ·±ãã†ãªäºº"], ["æ‹äººã«ç”˜ãˆãã†ãªäºº", "æ‹äººã‚’æŒ¯ã‚Šå›ã—ãã†ãªäºº"], ["æŸç¸›ãŒæ¿€ã—ãã†ãªäºº", "è‡ªç”±ã‚’æ„›ã—ãã†ãªäºº"]] },
            play: { classic: [["YouTube", "TikTok"], ["ã‚²ãƒ¼ãƒ ", "ãƒœãƒ‰ã‚²"], ["éŠåœ’åœ°", "æ°´æ—é¤¨"], ["æ—…è¡Œ", "ãŠã†ã¡æ™‚é–“"], ["æ˜ ç”»", "ãƒ‰ãƒ©ãƒ"], ["ã‚­ãƒ£ãƒ³ãƒ—", "ãƒ›ãƒ†ãƒ«æ³Š"], ["æ¼«ç”»", "ã‚¢ãƒ‹ãƒ¡"]], human: [["ã‚®ãƒ£ãƒ³ãƒ–ãƒ«å¼·ãã†ãªäºº", "ãã˜é‹ãŒçµ¶æœ›çš„ãªäºº"], ["å¤šè¶£å‘³ãã†ãªäºº", "ä¸€ã¤ã®ã“ã¨ã‚’æ¥µã‚ã‚‹äºº"], ["æµè¡Œã«æ•æ„Ÿãªäºº", "ãƒã‚¤ãƒŠãƒ¼ãªè¶£å‘³ã‚’æŒã¤äºº"]] },
            school: { classic: [["å®¿é¡Œ", "èª²é¡Œ"], ["å…ˆç”Ÿ", "ä¸Šå¸"], ["å›½èª", "æ•°å­¦"], ["é‹å‹•ä¼š", "æ–‡åŒ–ç¥­"], ["åˆ¶æœ", "ç§æœ"], ["ä¼‘ã¿æ™‚é–“", "æ”¾èª²å¾Œ"], ["éƒ¨æ´»", "å‹‰å¼·"]], human: [["æˆç¸¾ãŒå­¦å¹´ãƒˆãƒƒãƒ—ãã†ãªäºº", "é‹å‹•ç¥çµŒãŒåŒ–ã‘ç‰©ãªäºº"], ["ä¼šè­°ã§å¯ã¦ãã†ãªäºº", "å½±ã®ãƒªãƒ¼ãƒ€ãƒ¼ã£ã½ã„äºº"], ["æ ¡å‰‡ã‚’å…¨éƒ¨å®ˆã‚Šãã†ãªäºº", "å¤©æ‰è‚Œã®ä¸æ ¡å…ã£ã½ã„äºº"]] },
            life: { classic: [["å¸ƒå›£", "ãƒ™ãƒƒãƒ‰"], ["ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼", "ãƒªãƒ³ã‚¹"], ["æœé£Ÿ", "å¤•é£Ÿ"], ["ãŠé¢¨å‘‚", "ã‚·ãƒ£ãƒ¯ãƒ¼"], ["æƒé™¤", "æ´—æ¿¯"], ["ãƒ†ãƒ¬ãƒ“", "ã‚¹ãƒãƒ›"], ["ç¾é‡‘", "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹"]], human: [["æœã«æ¿€å¼±ãªäºº", "å¤œæ›´ã‹ã—ãŒé™ç•Œãªäºº"], ["æ½”ç™–ç—‡ãã†ãªäºº", "ã‚´ãƒŸå±‹æ•·ã«ä½ã‚“ã§ãã†ãªäºº"], ["è²¯é‡‘ãŒ1å„„å††ã‚ã‚Šãã†ãªäºº", "çµ¦æ–™æ—¥å‰ã‚‚ã‚„ã—ç”Ÿæ´»ãªäºº"]] },
            place: { classic: [["æ±äº¬", "å¤§é˜ª"], ["æµ·", "å±±"], ["ã‚³ãƒ³ãƒ“ãƒ‹", "ã‚¹ãƒ¼ãƒ‘ãƒ¼"], ["æ˜ ç”»é¤¨", "ãƒ—ãƒ©ãƒã‚¿ãƒªã‚¦ãƒ "], ["ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼", "USJ"], ["åŒ—æµ·é“", "æ²–ç¸„"], ["å…¬åœ’", "ãƒ‡ãƒ‘ãƒ¼ãƒˆ"]], human: [["è¿·å­ã«ãªã‚Šã‚„ã™ã„äºº", "æ–¹å‘æ„Ÿè¦šãŒé‡ç”Ÿãªäºº"], ["éƒ½ä¼šãŒä¼¼åˆã†äºº", "ç”°èˆãŒä¼¼åˆã†äºº"], ["ä¸€è»’å®¶ã«ä½ã‚“ã§ãã†ãªäºº", "ã‚¿ãƒ¯ãƒãƒ³ã«ä½ã‚“ã§ãã†ãªäºº"]] },
            emotion: { classic: [["ä¿¡é ¼", "å®‰å¿ƒ"], ["ç†æƒ³", "å¹»æƒ³"], ["å‹‡æ°—", "è¦šæ‚Ÿ"], ["æœŸå¾…", "ä¸å®‰"], ["æº€è¶³", "ç´å¾—"], ["è‡ªç”±", "è²¬ä»»"], ["ç§˜å¯†", "å…¬é–‹"]], human: [["æ€’ã‚‹ã¨é™ã‹ã«ãªã‚‹äºº", "æ€’ã‚‹ã¨èªå½™ãŒãªããªã‚‹äºº"], ["è¤’ã‚ã‚‰ã‚Œã‚‹ã¨ä¼¸ã³ã‚‹äºº", "ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã«å¼·ã„äºº"], ["å¸¸ã«å†·é™æ²ˆç€ãªäºº", "å®Ÿã¯å°å¿ƒè€…ãã†ãªäºº"]] }
        };

        const TOPIC_MASTER = {
            1: [
                "ãã®ãƒ¯ãƒ¼ãƒ‰ã‚’ã€Œæ¼¢å­—ä¸€æ–‡å­—ã€ã§è¡¨ã™ã¨ä½•ï¼Ÿ",
                "æœ€è¿‘ãã‚Œã‚’é£Ÿã¹ãŸã‚Šã€è¦‹ãŸã‚Šã—ãŸã®ã¯ã„ã¤ï¼Ÿï¼ˆé£²é£Ÿç³»ãªã‚‰å‘³ã®æ„Ÿæƒ³ã‚‚ï¼ï¼‰",
                "ãã®ãƒ¯ãƒ¼ãƒ‰ã®ã€Œã‚¤ãƒ¡ãƒ¼ã‚¸ã‚«ãƒ©ãƒ¼ã€ã‚’ã›ãƒ¼ã®ã§è¨€ãŠã†ï¼",
                "ãã‚Œã‚’ã€Œ3æ–‡å­—ã€ã§è¡¨ç¾ã™ã‚‹ãªã‚‰ï¼Ÿï¼ˆä¾‹ï¼šã‚ã¾ã„ã‚‚ã®ã€ãµã‚‹ã„ã‚‚ã®ï¼‰",
                "å…±é€šã®çŸ¥ã‚Šåˆã„ã§ã€ä¸€ç•ªãã‚ŒãŒä¼¼åˆã†ï¼ˆã¾ãŸã¯è¿‘ã„ï¼‰ã®ã¯èª°ï¼Ÿ"
            ],
            2: [
                "ãã‚Œã®ã€Œå€¤æ®µã€ã£ã¦ã€ã ã„ãŸã„ã©ã‚Œãã‚‰ã„ã ã¨æ€ã†ï¼Ÿ",
                "ãã‚Œã®ã€Œé‡ã•ã€ã‚„ã€Œã‚µã‚¤ã‚ºæ„Ÿã€ã‚’ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã§è¡¨ã—ã¦ã¿ã¦ï¼",
                "ãã‚Œã‚’æ“¬éŸ³ï¼ˆã‚ªãƒãƒãƒˆãƒšï¼‰ã§è¡¨ã™ã¨ã©ã‚“ãªæ„Ÿã˜ï¼Ÿ",
                "ä¸€æ—¥ã®ã†ã¡ã€ãã‚Œã‚’ä¸€ç•ªæ„è­˜ã™ã‚‹ã®ã¯ä½•æ™‚ã”ã‚ï¼Ÿ",
                "ãã‚Œã‚’æŒã£ã¦ã„ã‚‹ï¼ˆã¾ãŸã¯ã—ã¦ã„ã‚‹ï¼‰æ™‚ã€ã©ã‚“ãªæ°—åˆ†ã«ãªã‚‹ï¼Ÿ"
            ],
            3: [
                "ãã‚Œã‚’ã€Œä¸€è¨€ã§è¤’ã‚ã‚‹ã€ãªã‚‰ã€ãªã‚“ã¦è¨€ã†ï¼Ÿ",
                "é€†ã«ã€ãã‚Œã®ã€Œå›°ã‚‹ã¨ã“ã‚ã€ã‚’ä¸€ã¤æŒ™ã’ã‚‹ã¨ã—ãŸã‚‰ï¼Ÿ",
                "ã‚‚ã—ãã‚ŒãŒã€Œå­¦æ ¡ã®æ•™ç§‘ã€ã ã¨ã—ãŸã‚‰ã€ä½•ã ã¨æ€ã†ï¼Ÿ",
                "ãã‚Œã‚’ã€Œåˆ¥ã®ã‚‚ã®ã€ã«ä¾‹ãˆã‚‹ãªã‚‰ã€ä½•ã«è¿‘ã„ï¼Ÿ",
                "ä»Šã®ä¼šè©±ã‚’èã„ã¦ã€è‡ªåˆ†ã®ãƒ¯ãƒ¼ãƒ‰ã¨å‘¨ã‚Šã®ãƒ¯ãƒ¼ãƒ‰ã«ã‚ºãƒ¬ã‚’æ„Ÿã˜ã‚‹ï¼Ÿ"
            ]
        };

        // --- åˆæœŸåŒ– & URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯ ---
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const rid = params.get('room');
            if (rid) {
                document.getElementById('input-room-id').value = rid;
                const savedNick = localStorage.getItem('wolf_nick');
                if (savedNick) {
                    document.getElementById('input-nickname').value = savedNick;
                    handleJoinRoom();
                }
            }
        });

        window.showPage = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            setTimeout(() => document.getElementById(id).classList.add('active'), 50);
        };

        // --- ãƒœã‚¤ã‚¹ãƒãƒ£ãƒƒãƒˆ ---
        window.initSimpleVoice = async () => {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                document.getElementById('btn-start-voice').style.display = "none";
                document.getElementById('btn-mic-lobby').style.display = "flex";
                monitorVolume(localStream, state.myId);
                onValue(ref(db, `rooms/${state.roomId}/players`), (snap) => {
                    const players = snap.val();
                    for(let id in players) if(id !== state.myId && !peers[id]) callUser(id);
                }, { onlyOnce: true });
                listenForSignals();
            } catch (e) { alert("ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ã­ï¼"); }
        };

        function monitorVolume(stream, userId) {
            const source = audioContext.createMediaStreamSource(stream);
            const processor = audioContext.createScriptProcessor(2048, 1, 1);
            source.connect(processor); processor.connect(audioContext.destination);
            processor.onaudioprocess = (e) => {
                const input = e.inputBuffer.getChannelData(0);
                let sum = 0; for (let i = 0; i < input.length; i++) sum += input[i] * input[i];
                const rms = Math.sqrt(sum / input.length);
                const el = document.getElementById(`voice-user-${userId}`);
                if (el) rms > 0.05 ? el.classList.add('speaking') : el.classList.remove('speaking');
            };
        }

        async function callUser(userId) {
            const pc = createPeerConnection(userId);
            const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
            push(ref(db, `rooms/${state.roomId}/signals/${userId}`), { from: state.myId, type: 'offer', sdp: offer.sdp });
        }

        function listenForSignals() {
            onChildAdded(ref(db, `rooms/${state.roomId}/signals/${state.myId}`), async (snap) => {
                const data = snap.val();
                let pc = peers[data.from] || createPeerConnection(data.from);
                if (data.type === 'offer') {
                    await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: data.sdp }));
                    const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
                    push(ref(db, `rooms/${state.roomId}/signals/${data.from}`), { from: state.myId, type: 'answer', sdp: data.sdp });
                } else if (data.type === 'answer') await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: data.sdp }));
                else if (data.type === 'ice-candidate') await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            });
        }

        function createPeerConnection(userId) {
            const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            peers[userId] = pc;
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            pc.onicecandidate = (e) => e.candidate && push(ref(db, `rooms/${state.roomId}/signals/${userId}`), { from: state.myId, type: 'ice-candidate', candidate: e.candidate.toJSON() });
            pc.ontrack = (e) => {
                const audio = document.createElement('audio'); audio.srcObject = e.streams[0]; audio.autoplay = true; document.body.appendChild(audio);
                monitorVolume(e.streams[0], userId);
            };
            return pc;
        }

        window.toggleMic = () => {
            localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled;
            const enabled = localStream.getAudioTracks()[0].enabled;
            [document.getElementById('btn-mic-lobby'), document.getElementById('btn-mic-game')].forEach(b => {
                b.innerText = enabled ? "ğŸ™ï¸" : "ğŸ”‡"; b.style.background = enabled ? "var(--secondary)" : "var(--accent)";
            });
        };

        // --- éƒ¨å±‹ç®¡ç† ---
        window.handleCreateRoom = async () => {
            const nick = document.getElementById('input-nickname').value || "ã‚²ã‚¹ãƒˆ";
            localStorage.setItem('wolf_nick', nick);
            const rid = Math.random().toString(36).substring(2, 7).toUpperCase();
            state = { ...state, roomId: rid, myId: "p_"+Date.now(), nickname: nick, isHost: true };
            await set(ref(db, 'rooms/' + rid), { status: 'waiting', timer: 300, players: { [state.myId]: { name: nick, role: '', word: '' } } });
            onDisconnect(ref(db, `rooms/${rid}/players/${state.myId}`)).remove();
            listenToRoom(rid); showPage('page-lobby');
        };

        window.handleJoinRoom = async () => {
            const rid = document.getElementById('input-room-id').value.toUpperCase();
            const nick = document.getElementById('input-nickname').value || "ã‚²ã‚¹ãƒˆ";
            if (!rid) return alert("éƒ¨å±‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼");
            localStorage.setItem('wolf_nick', nick);
            state = { ...state, roomId: rid, myId: "p_"+Date.now(), nickname: nick, isHost: false };
            await update(ref(db, `rooms/${rid}/players/${state.myId}`), { name: nick, role: '', word: '' });
            onDisconnect(ref(db, `rooms/${rid}/players/${state.myId}`)).remove();
            listenToRoom(rid); showPage('page-lobby');
        };

        function listenToRoom(rid) {
            onValue(ref(db, 'rooms/' + rid), (snap) => {
                const data = snap.val(); if(!data) return;
                document.getElementById('display-room-id').innerText = rid;
                document.getElementById('voice-overlay').innerHTML = Object.entries(data.players || {}).map(([id, p]) => `<div id="voice-user-${id}" class="voice-user">${p.name}</div>`).join('');
                document.getElementById('host-settings').style.display = (state.isHost && data.status === 'waiting') ? 'block' : 'none';
                document.getElementById('guest-msg').style.display = state.isHost ? 'none' : 'block';
                const m = Math.floor(data.timer / 60); const s = data.timer % 60;
                document.getElementById('display-timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                if (data.currentTopicNum && data.topics) document.getElementById('display-topic').innerText = data.topics[data.currentTopicNum];
                if(data.status === 'playing' && !document.getElementById('page-game').classList.contains('active')) {
                    document.getElementById('display-my-word').innerText = data.players[state.myId]?.word || "...";
                    showPage('page-game'); if(state.isHost) startTimer(rid);
                }
                if(data.status === 'voting' && document.getElementById('page-game').classList.contains('active')) { setupVoteUI(data.players); showPage('page-vote'); }
                if(data.status === 'result') showResult(data);
            });
        }

        function startTimer(rid) {
            if(state.timerInterval) clearInterval(state.timerInterval);
            state.timerInterval = setInterval(() => {
                runTransaction(ref(db, `rooms/${rid}/timer`), (t) => {
                    if(t <= 0) { update(ref(db, `rooms/${rid}`), { status: 'voting' }); clearInterval(state.timerInterval); return 0; }
                    return t - 1;
                });
            }, 1000);
        }

        // --- ã‚²ãƒ¼ãƒ é€²è¡Œ ---
        window.handleStartGame = () => {
            const genre = document.getElementById('select-genre').value;
            const wolfCount = parseInt(document.getElementById('select-wolf-count').value);
            const setTime = parseInt(document.getElementById('select-timer').value);
            
            let pair;
            if(genre === 'random') {
                const allGenres = Object.values(THEMES);
                pair = selectFromGenre(allGenres[Math.floor(Math.random() * allGenres.length)]);
            } else {
                pair = selectFromGenre(THEMES[genre]);
            }
            const words = Math.random() > 0.5 ? [pair[0], pair[1]] : [pair[1], pair[0]];
            const sessionTopics = { 
                1: TOPIC_MASTER[1][Math.floor(Math.random() * TOPIC_MASTER[1].length)], 
                2: TOPIC_MASTER[2][Math.floor(Math.random() * TOPIC_MASTER[2].length)], 
                3: TOPIC_MASTER[3][Math.floor(Math.random() * TOPIC_MASTER[3].length)] 
            };

            onValue(ref(db, `rooms/${state.roomId}/players`), (snap) => {
                const players = snap.val();
                const ids = Object.keys(players).sort(() => 0.5 - Math.random());
                if(ids.length < 3 && wolfCount > 1) return alert("äººç‹¼2äººã¯ã€4äººä»¥ä¸Šå¿…è¦ã ã‚ˆï¼");
                
                const updates = { status: 'playing', timer: setTime, topics: sessionTopics, currentTopicNum: 0 };
                ids.forEach((id, i) => {
                    const isWolf = i < wolfCount;
                    updates[`/players/${id}/role`] = isWolf ? 'wolf' : 'citizen';
                    updates[`/players/${id}/word`] = isWolf ? words[1] : words[0];
                    updates[`/players/${id}/vote`] = '';
                });
                update(ref(db, `rooms/${state.roomId}`), updates);
            }, { onlyOnce: true });
        };

        function selectFromGenre(g) {
            const pool = Math.random() < 0.7 ? g.classic : g.human;
            return pool[Math.floor(Math.random() * pool.length)];
        }

        window.sendTopicRequest = (num) => update(ref(db, `rooms/${state.roomId}`), { currentTopicNum: num });
        window.handleGoToVote = () => update(ref(db, `rooms/${state.roomId}`), { status: 'voting' });
        function setupVoteUI(players) { document.getElementById('vote-container').innerHTML = Object.entries(players).filter(([id]) => id !== state.myId).map(([id, p]) => `<div class="btn btn-sub" onclick="castVote('${id}')">${p.name}</div>`).join(''); }
        window.castVote = (tid) => { update(ref(db, `rooms/${state.roomId}/players/${state.myId}`), { vote: tid }); onValue(ref(db, `rooms/${state.roomId}/players`), (snap) => { if(Object.values(snap.val()).every(p => p.vote !== "")) update(ref(db, `rooms/${state.roomId}`), { status: 'result' }); }, { onlyOnce: true }); };
        
        function showResult(data) {
            const wolves = Object.values(data.players).filter(p => p.role === 'wolf');
            const wolfNames = wolves.map(w => w.name).join(' ã¨ ');
            document.getElementById('result-info').innerHTML = `äººç‹¼ã¯ <b>${wolfNames}</b> ã§ã—ãŸï¼<br><div style="font-size:0.9rem; margin-top:10px; color:#666;">äººç‹¼ã®ãŠé¡Œï¼š${wolves[0].word}</div>`;
            showPage('page-result');
        }

        window.handleRestart = () => { if(state.isHost) update(ref(db, `rooms/${state.roomId}`), { status: 'waiting', timer: 300 }); showPage('page-lobby'); };
        
        window.copyInviteURL = () => {
            const url = `${window.location.origin}${window.location.pathname}?room=${state.roomId}`;
            navigator.clipboard.writeText(url).then(() => {
                const t = document.getElementById('toast');
                t.style.opacity = "1";
                setTimeout(() => t.style.opacity = "0", 2000);
            });
        };
    </script>
</body>
</html>
