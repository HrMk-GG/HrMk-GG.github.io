<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãµã‚ãµã‚ãƒ¯ãƒ¼ãƒ‰ã‚¦ãƒ«ãƒ• ğŸºğŸ­</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FFD93D;
            --secondary: #6BCB77;
            --accent: #FF6B6B;
            --bg: #FFF9CA;
            --text: #4D4D4D;
            --white: #ffffff;
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        /* ãªã‚ã‚‰ã‹ãªç”»é¢é·ç§» ğŸª„ */
        .page {
            position: absolute;
            width: 90%;
            max-width: 450px;
            padding: 30px;
            background: var(--white);
            border-radius: 30px;
            box-shadow: 0 10px 0 #E6D5A9;
            opacity: 0;
            transform: translateY(30px) scale(0.9);
            pointer-events: none;
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            box-sizing: border-box;
            max-height: 90vh;
            overflow-y: auto;
        }

        .page.active {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: all;
        }

        h1 { text-align: center; color: var(--accent); font-size: 1.8rem; margin: 0 0 20px 0; }
        h3 { font-size: 1.1rem; text-align: center; margin: 10px 0; }

        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            box-sizing: border-box;
        }

        .btn-main { background: var(--primary); color: #856600; box-shadow: 0 6px 0 #D4B42E; }
        .btn-sub { background: var(--secondary); color: var(--white); box-shadow: 0 6px 0 #4FA659; }
        .btn-accent { background: var(--accent); color: var(--white); box-shadow: 0 6px 0 #D14D4D; }
        .btn:active { transform: translateY(3px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }

        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 3px solid var(--primary);
            border-radius: 15px;
            font-family: inherit;
            font-size: 1rem;
            box-sizing: border-box;
            outline: none;
            background: #FFFBEB;
        }

        .room-id-display {
            background: #eee;
            padding: 10px;
            border-radius: 15px;
            font-size: 1.5rem;
            text-align: center;
            letter-spacing: 3px;
            margin-bottom: 20px;
            font-weight: 800;
        }

        .user-list { list-style: none; padding: 0; margin: 15px 0; }
        .user-list li {
            background: #F3F4F6;
            margin: 8px 0;
            padding: 12px 20px;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: popIn 0.4s ease-out forwards;
        }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .genre-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .genre-item {
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.3s;
        }

        .genre-item.selected {
            border-color: var(--secondary);
            background: #EFFFF0;
            font-weight: bold;
            transform: scale(1.05);
        }

        .timer-display { font-size: 4rem; text-align: center; color: var(--accent); text-shadow: 3px 3px 0 #FFD93D; margin: 10px 0; }
        .timer-controls { display: flex; gap: 10px; }

        .word-card {
            background: var(--primary);
            padding: 25px;
            border-radius: 25px;
            text-align: center;
            font-size: 2rem;
            margin: 20px 0;
            border: 4px dashed #856600;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .vote-item {
            background: #FFF;
            border: 3px solid var(--primary);
            margin: 8px 0;
            padding: 15px;
            border-radius: 20px;
            cursor: pointer;
            text-align: center;
            font-weight: 800;
            transition: 0.2s;
        }
        .vote-item.voted { background: var(--accent); color: white; border-color: var(--accent); }
    </style>
</head>
<body>

    <div id="page-home" class="page active">
        <h1>ğŸº Word Wolf</h1>
        <input type="text" id="input-nickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ï¼" maxlength="8">
        <button class="btn btn-main" onclick="handleCreateRoom()">éƒ¨å±‹ã‚’ä½œã‚‹ âœ¨</button>
        <div style="text-align:center; margin:15px; color:#aaa;">ãƒ¼ãƒ¼ ã¾ãŸã¯ ãƒ¼ãƒ¼</div>
        <input type="text" id="input-room-id" placeholder="5æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" maxlength="5">
        <button class="btn btn-sub" onclick="handleJoinRoom()">å‚åŠ ã™ã‚‹ ğŸšª</button>
    </div>

    <div id="page-lobby" class="page">
        <h1>å¾…æ©Ÿãƒ­ãƒ“ãƒ¼ ğŸ•’</h1>
        <div class="room-id-display" id="display-room-id">-----</div>
        <ul id="lobby-player-list" class="user-list"></ul>
        <div id="host-controls" style="display:none;">
            <h3>ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸ã‚“ã§ã­ ğŸ‘‡</h3>
            <div class="genre-grid" id="genre-grid"></div>
            <button class="btn btn-accent" onclick="handleStartGame()">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ğŸš€</button>
        </div>
        <div id="guest-msg" style="text-align:center; color:#888;">ãƒ›ã‚¹ãƒˆãŒé–‹å§‹ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
    </div>

    <div id="page-game" class="page">
        <h1>ã‚ãªãŸã®ãŠé¡Œ ğŸ¤«</h1>
        <div class="word-card" id="display-my-word">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div class="timer-display" id="display-timer">05:00</div>
        <div class="timer-controls" id="timer-ui-host" style="display:none;">
            <button class="btn btn-sub" onclick="changeTimer(60)">ï¼‹1åˆ†</button>
            <button class="btn btn-accent" onclick="changeTimer(-60)">ï¼1åˆ†</button>
        </div>
        <button class="btn btn-main" style="margin-top:20px;" onclick="handleGoToVote()">æŠ•ç¥¨ã¸é€²ã‚€ ğŸ‘‰</button>
    </div>

    <div id="page-vote" class="page">
        <h1>èª°ãŒäººç‹¼ï¼ŸğŸ—³ï¸</h1>
        <p style="text-align:center;">æ€ªã—ã„äººã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã­ï¼</p>
        <div id="vote-container"></div>
    </div>

    <div id="page-result" class="page">
        <h1>çµæœç™ºè¡¨ï¼ğŸŠ</h1>
        <div id="result-info" style="text-align:center; font-size:1.2rem; margin-bottom:20px;"></div>
        <ul id="result-details" class="user-list"></ul>
        <button class="btn btn-main" onclick="handleRestart()">ã‚‚ã†ä¸€åº¦éŠã¶ ğŸ”„</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAbZPrLSIygyIABnUGAHOigM9QmXdGRa8g",
            authDomain: "othello-hrmk.firebaseapp.com",
            projectId: "othello-hrmk",
            storageBucket: "othello-hrmk.firebasestorage.app",
            messagingSenderId: "804527745152",
            appId: "1:804527745152:web:0ab51db1cc348000801e65",
            measurementId: "G-ZJX6L6ZEFL"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const THEMES = {
            "ğŸ” é£²é£Ÿï¼ˆæ¿€ä¼¼ï¼‰": [["ã‚«ãƒ•ã‚§ãƒ©ãƒ†", "ã‚«ãƒ•ã‚§ã‚ªãƒ¬"], ["ãƒ‘ãƒ³ã‚±ãƒ¼ã‚­", "ãƒ›ãƒƒãƒˆã‚±ãƒ¼ã‚­"], ["ãŠã²ãŸã—", "èƒ¡éº»å’Œãˆ"], ["é†¤æ²¹", "ã‚ã‚“ã¤ã‚†"], ["ãƒãƒ†ãƒˆãƒãƒƒãƒ—ã‚¹", "ãƒ•ãƒ©ã‚¤ãƒ‰ãƒãƒ†ãƒˆ"], ["ãƒ“ã‚¹ã‚±ãƒƒãƒˆ", "ã‚¯ãƒƒã‚­ãƒ¼"], ["ãŠã«ãã‚Š", "ç„¼ããŠã«ãã‚Š"], ["ã‚¹ãƒ†ãƒ¼ã‚­", "ãƒ­ãƒ¼ã‚¹ãƒˆãƒ“ãƒ¼ãƒ•"], ["å”æšã’", "ç«œç”°æšã’"], ["ä¸­è¯ãã°", "ãƒ©ãƒ¼ãƒ¡ãƒ³"], ["ãƒ‘ã‚¹ã‚¿", "ã‚¹ãƒ‘ã‚²ãƒƒãƒ†ã‚£"], ["ã‚·ãƒ£ãƒ¼ãƒ™ãƒƒãƒˆ", "ã‚¸ã‚§ãƒ©ãƒ¼ãƒˆ"]],
            "â¤ï¸ æ‹æ„›ï¼ˆçµ¶å¦™ï¼‰": [["æµ®æ°—", "ä¸å€«"], ["ãƒ‡ãƒ¼ãƒˆ", "ãŠå‡ºã‹ã‘"], ["ä¸€ç›®æƒšã‚Œ", "ä¸€èãæƒšã‚Œ"], ["å…ƒã‚«ãƒ¬", "ä»Šã‚«ãƒ¬"], ["åˆã‚³ãƒ³", "è¡—ã‚³ãƒ³"], ["å‘Šç™½", "ãƒ—ãƒ­ãƒãƒ¼ã‚º"], ["ãƒ¤ã‚­ãƒ¢ãƒ", "å«‰å¦¬"], ["ãƒšã‚¢ãƒªãƒ³ã‚°", "ãƒšã‚¢ãƒãƒƒã‚¯ãƒ¬ã‚¹"], ["æ„›", "æ‹"]],
            "ğŸ« å­¦æ ¡ãƒ»æ—¥å¸¸": [["ç®—æ•°", "æ•°å­¦"], ["ç†ç§‘", "ç§‘å­¦"], ["å›½èª", "ç¾ä»£æ–‡"], ["å®¿é¡Œ", "èª²é¡Œ"], ["é è¶³", "ä¿®å­¦æ—…è¡Œ"], ["æ–‡åŒ–ç¥­", "å­¦åœ’ç¥­"], ["ä½“è‚²ç¥­", "é‹å‹•ä¼š"], ["ã‚·ãƒ£ãƒ¼ãƒšãƒ³", "é‰›ç­†"], ["æ•™ç§‘æ›¸", "å‚è€ƒæ›¸"]],
            "ğŸ  ç”Ÿæ´»ãƒ»å®¶é›»": [["æ´—æ¿¯æ©Ÿ", "ä¹¾ç‡¥æ©Ÿ"], ["å†·è”µåº«", "å†·å‡åº«"], ["é›»å­ãƒ¬ãƒ³ã‚¸", "ã‚ªãƒ¼ãƒ–ãƒ³"], ["å¸ƒå›£", "æ¯›å¸ƒ"], ["æ•", "ã‚¯ãƒƒã‚·ãƒ§ãƒ³"], ["ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼", "ãƒªãƒ³ã‚¹"], ["æ‰‡é¢¨æ©Ÿ", "ã‚¨ã‚¢ã‚³ãƒ³"]],
            "ğŸ¶ å‹•ç‰©ãƒ»è‡ªç„¶": [["ã‚¢ã‚·ã‚«", "ã‚¢ã‚¶ãƒ©ã‚·"], ["ã‚¤ãƒ«ã‚«", "ã‚·ãƒ£ãƒ"], ["ãƒªã‚¹", "ãƒãƒ ã‚¹ã‚¿ãƒ¼"], ["å±±", "ä¸˜"], ["æµ·", "æ¹–"], ["å·", "æ»"], ["é›¨", "éœ§é›¨"]],
            "ğŸ¥ ã‚¨ãƒ³ã‚¿ãƒ¡": [["YouTube", "TikTok"], ["æ˜ ç”»", "ãƒ‰ãƒ©ãƒ"], ["æ¼«ç”»", "ã‚¢ãƒ‹ãƒ¡"], ["ãƒˆãƒ©ãƒ³ãƒ—", "UNO"], ["Instagram", "X(Twitter)"]],
            "ğŸ’¼ ä»•äº‹ãƒ»ç¤¾ä¼š": [["ä¼šè­°", "æ‰“ã¡åˆã‚ã›"], ["æ®‹æ¥­", "ä¼‘æ—¥å‡ºå‹¤"], ["ååˆº", "èº«åˆ†è¨¼"], ["ä¸Šå¸", "ç¤¾é•·"], ["çµ¦æ–™", "ãƒœãƒ¼ãƒŠã‚¹"], ["ãƒ¡ãƒ¼ãƒ«", "ãƒãƒ£ãƒƒãƒˆ"]],
            "ğŸ§¤ æŒã¡ç‰©ãƒ»æœ": [["ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼", "é‹å‹•é´"], ["ã‚µãƒ³ãƒ€ãƒ«", "ã‚¹ãƒªãƒƒãƒ‘"], ["ãƒªãƒ¥ãƒƒã‚¯", "ãƒ©ãƒ³ãƒ‰ã‚»ãƒ«"], ["å¸½å­", "ãƒ˜ãƒ«ãƒ¡ãƒƒãƒˆ"], ["çœ¼é¡", "ã‚µãƒ³ã‚°ãƒ©ã‚¹"], ["å‚˜", "ã‚«ãƒƒãƒ‘"]]
        };

        let state = { roomId: "", myId: "", nickname: "", isHost: false, selectedGenre: "ğŸ” é£²é£Ÿï¼ˆæ¿€ä¼¼ï¼‰", hasVoted: false, timerInterval: null };

        window.showPage = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            setTimeout(() => document.getElementById(id).classList.add('active'), 50);
        };

        window.handleCreateRoom = () => {
            const nick = document.getElementById('input-nickname').value || "ãªãªã—";
            const rid = Math.random().toString(36).substring(2, 7).toUpperCase();
            state.myId = "p_" + Date.now();
            state.roomId = rid;
            state.nickname = nick;
            state.isHost = true;

            set(ref(db, 'rooms/' + rid), {
                status: 'waiting',
                timer: 300,
                genre: "ğŸ” é£²é£Ÿï¼ˆæ¿€ä¼¼ï¼‰",
                hostId: state.myId,
                players: { [state.myId]: { name: nick, role: '', word: '', vote: '', isOnline: true } }
            });
            initGenreGrid();
            listenToRoom(rid);
            showPage('page-lobby');
        };

        window.handleJoinRoom = () => {
            const rid = document.getElementById('input-room-id').value.toUpperCase();
            const nick = document.getElementById('input-nickname').value || "ãªãªã—";
            if(rid.length !== 5) return alert("5æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ã­ï¼");
            state.myId = "p_" + Date.now();
            state.roomId = rid;
            state.nickname = nick;
            state.isHost = false;

            update(ref(db, `rooms/${rid}/players/${state.myId}`), { name: nick, role: '', word: '', vote: '', isOnline: true });
            listenToRoom(rid);
            showPage('page-lobby');
        };

        function initGenreGrid() {
            const grid = document.getElementById('genre-grid');
            grid.innerHTML = "";
            Object.keys(THEMES).forEach(g => {
                const div = document.createElement('div');
                div.className = `genre-item ${g === state.selectedGenre ? 'selected' : ''}`;
                div.innerText = g;
                div.onclick = () => {
                    state.selectedGenre = g;
                    update(ref(db, `rooms/${state.roomId}`), { genre: g });
                };
                grid.appendChild(div);
            });
        }

        function listenToRoom(rid) {
            document.getElementById('display-room-id').innerText = rid;
            onValue(ref(db, 'rooms/' + rid), (snapshot) => {
                const data = snapshot.val();
                if(!data) return;

                const list = document.getElementById('lobby-player-list');
                list.innerHTML = "";
                Object.entries(data.players).forEach(([id, p]) => {
                    list.innerHTML += `<li>${p.name} ${id === data.hostId ? 'ğŸ‘‘' : ''} <span>âœ…</span></li>`;
                });

                document.getElementById('host-controls').style.display = state.isHost ? 'block' : 'none';
                document.getElementById('guest-msg').style.display = state.isHost ? 'none' : 'block';
                document.getElementById('timer-ui-host').style.display = state.isHost ? 'flex' : 'none';

                const m = Math.floor(data.timer / 60);
                const s = data.timer % 60;
                document.getElementById('display-timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;

                if(!state.isHost) {
                    state.selectedGenre = data.genre;
                } else {
                    document.querySelectorAll('.genre-item').forEach(el => el.classList.toggle('selected', el.innerText === data.genre));
                }

                if(data.status === 'playing' && document.getElementById('page-lobby').classList.contains('active')) {
                    document.getElementById('display-my-word').innerText = data.players[state.myId].word;
                    showPage('page-game');
                    if(state.isHost) startTimerCountdown();
                }
                if(data.status === 'voting' && document.getElementById('page-game').classList.contains('active')) {
                    clearInterval(state.timerInterval);
                    setupVoteUI(data.players);
                    showPage('page-vote');
                }
                if(data.status === 'result') {
                    showResult(data);
                    showPage('page-result');
                }
            });
        }

        function startTimerCountdown() {
            if(state.timerInterval) clearInterval(state.timerInterval);
            state.timerInterval = setInterval(() => {
                runTransaction(ref(db, `rooms/${state.roomId}/timer`), (t) => {
                    if(t <= 0) { clearInterval(state.timerInterval); return 0; }
                    return t - 1;
                });
            }, 1000);
        }

        window.handleStartGame = () => {
            const pairs = THEMES[state.selectedGenre];
            const pair = pairs[Math.floor(Math.random() * pairs.length)];
            const words = Math.random() > 0.5 ? [pair[0], pair[1]] : [pair[1], pair[0]];

            onValue(ref(db, `rooms/${state.roomId}/players`), (snap) => {
                const players = snap.val();
                const ids = Object.keys(players);
                const wolfId = ids[Math.floor(Math.random() * ids.length)];
                const updates = {};
                ids.forEach(id => {
                    updates[`/players/${id}/role`] = (id === wolfId ? 'wolf' : 'citizen');
                    updates[`/players/${id}/word`] = (id === wolfId ? words[1] : words[0]);
                    updates[`/players/${id}/vote`] = '';
                });
                updates['/status'] = 'playing';
                update(ref(db, `rooms/${state.roomId}`), updates);
            }, { onlyOnce: true });
        };

        window.changeTimer = (val) => {
            runTransaction(ref(db, `rooms/${state.roomId}/timer`), (t) => Math.max(0, (t || 0) + val));
        };

        window.handleGoToVote = () => update(ref(db, `rooms/${state.roomId}`), { status: 'voting' });

        function setupVoteUI(players) {
            const container = document.getElementById('vote-container');
            container.innerHTML = "";
            Object.entries(players).forEach(([id, p]) => {
                if(id === state.myId) return;
                const div = document.createElement('div');
                div.className = 'vote-item';
                div.innerText = p.name;
                div.onclick = () => {
                    if(state.hasVoted) return;
                    state.hasVoted = true;
                    div.classList.add('voted');
                    update(ref(db, `rooms/${state.roomId}/players/${state.myId}`), { vote: id });
                    checkAllVoted();
                };
                container.appendChild(div);
            });
        }

        function checkAllVoted() {
            onValue(ref(db, `rooms/${state.roomId}`), (snap) => {
                const data = snap.val();
                const players = Object.values(data.players);
                if(players.filter(p => p.vote !== "").length >= players.length) {
                    update(ref(db, `rooms/${state.roomId}`), { status: 'result' });
                }
            }, { onlyOnce: true });
        }

        function showResult(data) {
            const info = document.getElementById('result-info');
            const details = document.getElementById('result-details');
            const wolf = Object.values(data.players).find(p => p.role === 'wolf');
            info.innerHTML = `æ­£ä½“ã¯ <b>${wolf.name}</b> ã•ã‚“ï¼<br>ãŠé¡Œï¼š${wolf.word}`;
            details.innerHTML = "";
            Object.values(data.players).forEach(p => {
                details.innerHTML += `<li>${p.name} <span>${p.role === 'wolf' ? 'äººç‹¼ğŸº' : 'å¸‚æ°‘ğŸ‘¤'}</span></li>`;
            });
        }

        window.handleRestart = () => {
            state.hasVoted = false;
            if(state.isHost) update(ref(db, `rooms/${state.roomId}`), { status: 'waiting', timer: 300 });
            showPage('page-lobby');
        };
    </script>
</body>
</html>
