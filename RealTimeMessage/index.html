<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Danmaku Chat</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #000; font-family: "Helvetica Neue", Arial, sans-serif; overflow: hidden; height: 100vh; }

        /* 弾幕が流れるステージ */
        #danmaku-stage {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1;
        }

        .comment {
            position: absolute; white-space: nowrap; font-weight: bold;
            text-shadow: 2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000;
            animation: flow linear forwards;
            will-change: transform;
        }

        @keyframes flow {
            from { transform: translateX(100vw); }
            to { transform: translateX(-100%); }
        }

        /* 下部の操作パネル */
        .ui-panel {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100; background: rgba(255, 255, 255, 0.9);
            padding: 15px 25px; border-radius: 50px;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
        }

        .input-group { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #666; font-weight: bold; }
        
        input[type="text"] { border: 1px solid #ccc; padding: 10px; border-radius: 20px; outline: none; }
        #nickname { width: 80px; }
        #message { width: 250px; }
        
        #send-btn {
            background: #ff4b2b; color: white; border: none; padding: 10px 25px;
            border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        #send-btn:hover { background: #ff2a00; transform: scale(1.05); }
    </style>
</head>
<body>

    <div id="danmaku-stage"></div>

    <div class="ui-panel">
        <div class="input-group">
            <span>NAME</span>
            <input type="text" id="nickname" placeholder="名無し" maxlength="10">
        </div>
        
        <div class="input-group">
            <span>COLOR</span>
            <input type="color" id="color" value="#ffffff">
        </div>

        <div class="input-group">
            <span>SIZE</span>
            <input type="range" id="size" min="20" max="100" value="40">
        </div>

        <input type="text" id="message" placeholder="何かメッセージを打ってね！" maxlength="50">
        
        <button id="send-btn">流す！</button>
    </div>

<script>
// --- 君のFirebase設定（反映済み！） ---
const firebaseConfig = {
  apiKey: "AIzaSyCxexufR8PjjXe_AjkObG2bwvAxYgd6P4U",
  authDomain: "realtimemessage-754ef.firebaseapp.com",
  projectId: "realtimemessage-754ef",
  storageBucket: "realtimemessage-754ef.firebasestorage.app",
  messagingSenderId: "727350340778",
  appId: "1:727350340778:web:5b271891c83c7e5400b4d3",
  measurementId: "G-M7G5MQ90CK"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// 弾幕を表示させる関数
function launch(text, color, size) {
    const stage = document.getElementById('danmaku-stage');
    const div = document.createElement('div');
    div.className = 'comment';
    div.innerText = text;
    div.style.color = color;
    div.style.fontSize = size + "px";
    
    // 重ならないようにランダムな高さに配置（上部5%〜90%の間）
    div.style.top = (Math.random() * 85 + 5) + "%";
    
    // 文字数に応じて流れる速度を調整（短いと速く、長いと遅く）
    const speed = Math.random() * 3 + 4; // 4s〜7s
    div.style.animationDuration = speed + "s";
    
    stage.appendChild(div);
    
    // 流れ終わったらDOMから消す（メモリ節約！）
    setTimeout(() => div.remove(), speed * 1000);
}

// 送信ボタンクリック
document.getElementById('send-btn').onclick = async () => {
    const msg = document.getElementById('message').value.trim();
    const name = document.getElementById('nickname').value || "名無し";
    const color = document.getElementById('color').value;
    const size = document.getElementById('size').value;

    if (!msg) return;

    // Firestoreにデータを追加
    await db.collection("comments").add({
        content: `[${name}] ${msg}`,
        color: color,
        size: parseInt(size),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById('message').value = ""; // 入力欄を空に
};

// Enterキーでも送信できるように
document.getElementById('message').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') document.getElementById('send-btn').click();
});

// リアルタイムでデータを監視（ここが肝！）
db.collection("comments")
  .orderBy("createdAt", "desc")
  .limit(1)
  .onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
        if (change.type === "added") {
            const data = change.doc.data();
            // サーバーからデータが届いたら画面に流す
            if (data.content) {
                launch(data.content, data.color, data.size);
            }
        }
    });
});
</script>
</body>
</html>
