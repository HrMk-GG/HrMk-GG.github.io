<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moment Swap - Final Battle</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        body { background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%); color: #E2E2E2; font-family: sans-serif; margin: 0; min-height: 100vh; text-align: center; }
        .hidden { display: none !important; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .btn { background: linear-gradient(45deg, #4fc3f7, #9575cd); color: white; padding: 18px 45px; border-radius: 50px; font-weight: bold; border: none; cursor: pointer; font-size: 1.1rem; }
        video { width: 90%; max-width: 400px; border-radius: 20px; border: 2px solid #4fc3f7; margin-top: 20px; }
        .card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px; width: 85%; max-width: 380px; border: 1px solid rgba(255,255,255,0.1); margin: 15px auto; }
        .card img { width: 100%; border-radius: 10px; }
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #4fc3f7; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg) } 100% { transform: rotate(360deg) } }
    </style>
</head>
<body>

<div id="loading-overlay">
    <span class="loader"></span>
    <p>æ˜Ÿç©ºã¨äº¤ä¿¡ä¸­...</p>
    <p id="debug-log" style="font-size: 0.7rem; color: #555;"></p>
</div>

<div id="overlay" class="hidden">
    <div id="login-ui">
        <h1>Moment Swap</h1>
        <button id="login-btn" class="btn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <p style="font-size: 0.8rem; margin-top: 20px; color: #777;">â€»ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œã«é€²ã¾ãªã„å ´åˆã¯<br>Cookieã‚’è¨±å¯ã—ã¦ã­</p>
    </div>
    <div id="name-ui" class="hidden">
        <h2>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’æ±ºã‚ã¦ã­</h2>
        <input type="text" id="nickname" maxlength="10" style="padding:15px; border-radius:10px;">
        <br><br>
        <button class="btn" onclick="registerName()">éŠ€æ²³ã¸å‡ºç™º</button>
    </div>
</div>

<div id="main" class="hidden">
    <h1>Moment Swap</h1>
    <video id="camera" autoplay playsinline></video>
    <canvas id="output" class="hidden"></canvas>
    <p id="user-info"></p>
    <button id="swap-btn" class="btn">ğŸŒŸ ä»Šã‚’æ’®ã£ã¦äº¤æ›ã™ã‚‹</button>
    <p id="status">æº–å‚™ä¸­...</p>
    <div id="history"></div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAWVuyKmGKY04Xnpia_2ehtG8fVW5rLX3s",
  authDomain: "photo-share-9405d.firebaseapp.com",
  projectId: "photo-share-9405d",
  storageBucket: "photo-share-9405d.firebasestorage.app",
  messagingSenderId: "218976247260",
  appId: "1:218976247260:web:52f9c93559065317f7c319"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ãƒ­ã‚°å‡ºåŠ›ç”¨
function log(msg) { document.getElementById('debug-log').innerText += msg + "\n"; }

async function startApp() {
    log("èªè¨¼ãƒã‚§ãƒƒã‚¯é–‹å§‹...");
    try {
        // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆçµæœã‚’å¾…ã¤ï¼ˆæœ€å¤§5ç§’ï¼‰
        const result = await auth.getRedirectResult().catch(e => { log("Redirect Error: " + e.message); });
        
        auth.onAuthStateChanged(async (user) => {
            log("StateChanged: " + (user ? "LoggedIn" : "LoggedOut"));
            document.getElementById('loading-overlay').classList.add('hidden');
            
            if (user) {
                const doc = await db.collection("users").doc(user.uid).get();
                if (doc.exists()) {
                    myName = doc.data().nickname;
                    showMainUI();
                } else {
                    document.getElementById('overlay').classList.remove('hidden');
                    document.getElementById('login-ui').classList.add('hidden');
                    document.getElementById('name-ui').classList.remove('hidden');
                }
            } else {
                document.getElementById('overlay').classList.remove('hidden');
            }
        });
    } catch (e) {
        log("Fatal Error: " + e.message);
    }
}

document.getElementById('login-btn').onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    // ã“ã“ãŒãƒŸã‚½ï¼šãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ˜ç¤ºçš„ã«LOCALã«ã™ã‚‹
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
        return auth.signInWithRedirect(provider);
    });
};

// ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç™»éŒ²
let myName = "";
async function registerName() {
    const name = document.getElementById('nickname').value;
    if (!name) return alert("åå‰ã‚’å…¥ã‚Œã¦ï¼");
    await db.collection("users").doc(auth.currentUser.uid).set({ nickname: name });
    myName = name;
    showMainUI();
}

// ãƒ¡ã‚¤ãƒ³è¡¨ç¤º
async function showMainUI() {
    document.getElementById('overlay').classList.add('hidden');
    document.getElementById('main').classList.remove('hidden');
    document.getElementById('user-info').innerText = `Explorer: ${myName}`;
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    document.getElementById('camera').srcObject = stream;
}

// å†™çœŸäº¤æ›
document.getElementById('swap-btn').onclick = async () => {
    const btn = document.getElementById('swap-btn');
    const stat = document.getElementById('status');
    btn.disabled = true;
    stat.innerText = "æ’®å½±ä¸­...";
    const canvas = document.getElementById('output');
    canvas.width = 300; canvas.height = 400;
    canvas.getContext('2d').drawImage(document.getElementById('camera'), 0, 0, 300, 400);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.4);

    stat.innerText = "éŠ€æ²³ã‚’æ¤œç´¢ä¸­...";
    const waitingRooms = await db.collection("waiting").orderBy("time", "asc").limit(1).get();

    if (waitingRooms.empty) {
        await db.collection("waiting").doc(auth.currentUser.uid).set({ uid: auth.currentUser.uid, nickname: myName, photoData: dataUrl, time: Date.now() });
        const unsubscribe = db.collection("swaps").doc(auth.currentUser.uid).onSnapshot((doc) => {
            if (doc.exists()) {
                const data = doc.data();
                addHistory(data.partnerName, data.partnerPhoto);
                stat.innerText = "äº¤ä¿¡æˆåŠŸï¼";
                btn.disabled = false;
                db.collection("swaps").doc(auth.currentUser.uid).delete();
                unsubscribe();
            }
        });
        stat.innerText = "èª°ã‚‚ã„ã¾ã›ã‚“...ï¼ˆä¿¡å·é€ä¿¡ä¸­ï¼‰";
    } else {
        const partner = waitingRooms.docs[0].data();
        await db.collection("waiting").doc(partner.uid).delete();
        await db.collection("swaps").doc(partner.uid).set({ partnerName: myName, partnerPhoto: dataUrl });
        addHistory(partner.nickname, partner.photoData);
        stat.innerText = "äº¤ä¿¡æˆåŠŸï¼";
        btn.disabled = false;
    }
};

function addHistory(name, url) {
    const item = `<div class="card"><span style="color:#4fc3f7">ğŸš€ ${name}</span><img src="${url}"></div>`;
    document.getElementById('history').insertAdjacentHTML('afterbegin', item);
}

startApp();
</script>
</body>
</html>
