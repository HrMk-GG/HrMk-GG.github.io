<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moment Swap - Starry Night Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        /* æ˜Ÿç©ºã®èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        body {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            color: #E2E2E2;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding-bottom: 50px;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* ç¬ãæ˜Ÿã®ç”Ÿæˆï¼ˆCSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: transparent url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/123163/stars.png') repeat;
            z-index: -1;
            opacity: 0.5;
            animation: move-stars 200s linear infinite;
        }

        @keyframes move-stars {
            from { background-position: 0 0; }
            to { background-position: 10000px 5000px; }
        }

        h1 {
            font-size: 2.5rem;
            color: #fff;
            text-shadow: 0 0 20px #4fc3f7;
            margin-top: 30px;
        }

        .hidden { display: none; }

        /* ã‚«ãƒ¡ãƒ©ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ ã‚’å…‰ã‚‰ã›ã‚‹ */
        video, canvas {
            width: 90%;
            max-width: 400px;
            border: 2px solid rgba(79, 195, 247, 0.5);
            border-radius: 25px;
            margin-top: 20px;
            box-shadow: 0 0 30px rgba(79, 195, 247, 0.3);
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
        }

        /* å¹»æƒ³çš„ãªãƒœã‚¿ãƒ³ */
        .btn {
            background: linear-gradient(45deg, #4fc3f7, #9575cd);
            color: white;
            padding: 18px 45px;
            border-radius: 50px;
            font-weight: bold;
            border: none;
            margin: 20px;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 5px 15px rgba(149, 117, 205, 0.4);
            transition: 0.3s;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(149, 117, 205, 0.6);
        }

        .btn:disabled {
            background: #444;
            box-shadow: none;
        }

        /* å±¥æ­´ã®ã‚«ãƒ¼ãƒ‰ã‚’é€æ˜æ„Ÿã®ã‚ã‚‹ã‚¬ãƒ©ã‚¹é¢¨ã« */
        .card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 20px;
            width: 85%;
            max-width: 380px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .card img {
            width: 100%;
            border-radius: 12px;
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .name {
            color: #4fc3f7;
            font-weight: bold;
            font-size: 1.2rem;
            display: block;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ãƒ»åå‰ç™»éŒ²ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1B2735 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000;
        }

        input {
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #4fc3f7;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            width: 70%;
            font-size: 1.1rem;
            outline: none;
            text-align: center;
        }
    </style>
</head>
<body>

<div id="overlay">
    <div id="login-ui">
        <h1>Moment Swap</h1>
        <p style="color: #4fc3f7;">æ˜Ÿé™ã‚‹å¤œã«ã€ä»Šã‚’äº¤æ›ã—ã‚ˆã†</p>
        <button class="btn" onclick="login()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    <div id="name-ui" class="hidden">
        <h2>å®‡å®™ã§ã®åå‰ã‚’æ±ºã‚ã¦ã­</h2>
        <input type="text" id="nickname" maxlength="10" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
        <br>
        <button class="btn" onclick="registerName()">éŠ€æ²³ã¸å‡ºç™ºï¼</button>
    </div>
</div>

<div id="main" class="hidden">
    <h1>Moment Swap</h1>
    <video id="camera" autoplay playsinline></video>
    <canvas id="output" class="hidden"></canvas>
    <p id="user-info" style="color: #9575cd;"></p>
    <button id="swap-btn" class="btn">ğŸŒŸ ä»Šã‚’æ’®ã£ã¦äº¤æ›ã™ã‚‹</button>
    <p id="status">æ˜Ÿç©ºã‚’è¦³æ¸¬ä¸­...</p>
    
    <div id="history">
        <h3 style="margin-top: 40px; border-bottom: 2px solid rgba(79, 195, 247, 0.3); padding-bottom: 10px; width: 80%;">å—ä¿¡ã—ãŸæ˜Ÿåº§</h3>
    </div>
</div>

<script>
// --- å›ã®Firebaseè¨­å®šï¼ˆä»¥å‰ã®ã‚„ã¤ã‚’ãã®ã¾ã¾ä½¿ã†ã‚ˆï¼ï¼‰ ---
const firebaseConfig = {
  apiKey: "AIzaSyAWVuyKmGKY04Xnpia_2ehtG8fVW5rLX3s",
  authDomain: "photo-share-9405d.firebaseapp.com",
  projectId: "photo-share-9405d",
  storageBucket: "photo-share-9405d.firebasestorage.app",
  messagingSenderId: "218976247260",
  appId: "1:218976247260:web:52f9c93559065317f7c319"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let myName = "";
const camera = document.getElementById('camera');
const swapBtn = document.getElementById('swap-btn');
const status = document.getElementById('status');

async function login() {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
}

auth.onAuthStateChanged(async (user) => {
    if (user) {
        const doc = await db.collection("users").doc(user.uid).get();
        if (doc.exists()) {
            myName = doc.data().nickname;
            startApp();
        } else {
            document.getElementById('login-ui').classList.add('hidden');
            document.getElementById('name-ui').classList.remove('hidden');
        }
    }
});

async function registerName() {
    const name = document.getElementById('nickname').value;
    if (!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼");
    await db.collection("users").doc(auth.currentUser.uid).set({ nickname: name });
    myName = name;
    startApp();
}

async function startApp() {
    document.getElementById('overlay').classList.add('hidden');
    document.getElementById('main').classList.remove('hidden');
    document.getElementById('user-info').innerText = `âœ¨ Explorer: ${myName}`;
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    camera.srcObject = stream;
    status.innerText = "äº¤ä¿¡æº–å‚™å®Œäº†";
}

swapBtn.onclick = async () => {
    swapBtn.disabled = true;
    status.innerText = "å†™çœŸã‚’ç¾åƒä¸­...";

    const canvas = document.getElementById('output');
    canvas.width = 300; 
    canvas.height = 400;
    canvas.getContext('2d').drawImage(camera, 0, 0, 300, 400);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.5);

    status.innerText = "éŠ€æ²³ã®å‘ã“ã†å´ã‚’æ¢ã—ã¦ã„ã¾ã™...";
    
    const waitingRooms = await db.collection("waiting").limit(1).get();

    if (waitingRooms.empty) {
        await db.collection("waiting").doc(auth.currentUser.uid).set({
            uid: auth.currentUser.uid,
            nickname: myName,
            photoData: dataUrl,
            time: Date.now()
        });
        
        const unsubscribe = db.collection("swaps").doc(auth.currentUser.uid)
            .onSnapshot((doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    addHistory(data.partnerName, data.partnerPhoto);
                    status.innerText = "äº¤ä¿¡æˆåŠŸï¼";
                    swapBtn.disabled = false;
                    unsubscribe();
                }
            });
        status.innerText = "èª°ã‚‚ã„ãªã„ã‚ˆã†ã§ã™... ä¿¡å·ã‚’é€ä¿¡ã—ç¶šã‘ã¦ã„ã¾ã™...";
    } else {
        const partner = waitingRooms.docs[0].data();
        await db.collection("waiting").doc(partner.uid).delete();

        await db.collection("swaps").doc(partner.uid).set({
            partnerName: myName,
            partnerPhoto: dataUrl
        });

        addHistory(partner.nickname, partner.photoData);
        status.innerText = "äº¤ä¿¡æˆåŠŸï¼";
        swapBtn.disabled = false;
    }
};

function addHistory(name, url) {
    const html = `<div class="card"><span class="name">ğŸš€ ${name}</span><img src="${url}"></div>`;
    document.getElementById('history').insertAdjacentHTML('afterbegin', html);
}
</script>
</body>
</html>
