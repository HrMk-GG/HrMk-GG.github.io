<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moment Swap - Final Starry Night</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        /* èƒŒæ™¯ãƒ‡ã‚¶ã‚¤ãƒ³ã¯ã•ã£ãã®æ˜Ÿç©ºã‚’ç¶™æ‰¿ */
        body { background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%); color: #E2E2E2; font-family: sans-serif; margin: 0; padding-bottom: 50px; min-height: 100vh; text-align: center; }
        .hidden { display: none !important; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .btn { background: linear-gradient(45deg, #4fc3f7, #9575cd); color: white; padding: 18px 45px; border-radius: 50px; font-weight: bold; border: none; cursor: pointer; font-size: 1.2rem; box-shadow: 0 5px 15px rgba(149,117,205,0.4); }
        video { width: 90%; max-width: 400px; border-radius: 25px; border: 2px solid #4fc3f7; margin-top: 20px; }
        .card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 20px; width: 85%; max-width: 380px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); margin: 10px auto; }
        .card img { width: 100%; border-radius: 12px; }
    </style>
</head>
<body>

<div id="overlay">
    <div id="login-ui">
        <h1>Moment Swap</h1>
        <p style="color: #4fc3f7;">æ˜Ÿç©ºã®ä¸‹ã§å†™çœŸã‚’äº¤æ›</p>
        <button id="google-login-btn" class="btn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <p id="login-status" style="font-size: 0.8rem; margin-top: 10px;"></p>
    </div>
    <div id="name-ui" class="hidden">
        <h2>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’æ±ºã‚ã¦ã­</h2>
        <input type="text" id="nickname" maxlength="10" style="padding:15px; border-radius:10px; text-align:center;">
        <br><br>
        <button class="btn" onclick="registerName()">éŠ€æ²³ã¸å‡ºç™ºï¼</button>
    </div>
</div>

<div id="main" class="hidden">
    <h1>Moment Swap</h1>
    <video id="camera" autoplay playsinline></video>
    <canvas id="output" class="hidden"></canvas>
    <p id="user-info"></p>
    <button id="swap-btn" class="btn">ğŸŒŸ ä»Šã‚’æ’®ã£ã¦äº¤æ›ã™ã‚‹</button>
    <p id="status">æº–å‚™ä¸­...</p>
    <div id="history"><h3>å—ä¿¡ã—ãŸæ˜Ÿåº§</h3></div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAWVuyKmGKY04Xnpia_2ehtG8fVW5rLX3s",
  authDomain: "photo-share-9405d.firebaseapp.com",
  projectId: "photo-share-9405d",
  storageBucket: "photo-share-9405d.firebasestorage.app",
  messagingSenderId: "218976247260",
  appId: "1:218976247260:web:52f9c93559065317f7c319"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®å‡¦ç†
document.getElementById('google-login-btn').onclick = () => {
    document.getElementById('login-status').innerText = "ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ç§»å‹•ä¸­...";
    const provider = new firebase.auth.GoogleAuthProvider();
    // ã“ã“ã§Redirectã‚’ä½¿ã†ï¼
    auth.signInWithRedirect(provider);
};

// ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ãƒã‚§ãƒƒã‚¯
auth.getRedirectResult().then((result) => {
    if (result.user) {
        console.log("Redirectãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:", result.user);
    }
}).catch((error) => {
    console.error("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", error);
    document.getElementById('login-status').innerText = "ã‚¨ãƒ©ãƒ¼: " + error.message;
});

auth.onAuthStateChanged(async (user) => {
    if (user) {
        const doc = await db.collection("users").doc(user.uid).get();
        if (doc.exists()) {
            myName = doc.data().nickname;
            startApp();
        } else {
            document.getElementById('login-ui').classList.add('hidden');
            document.getElementById('name-ui').classList.remove('hidden');
        }
    }
});

// ä»¥é™ã€å‰å›ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç™»éŒ²ãƒ»ã‚«ãƒ¡ãƒ©ãƒ»äº¤æ›ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶™æ‰¿
let myName = "";
const camera = document.getElementById('camera');
const swapBtn = document.getElementById('swap-btn');
const status = document.getElementById('status');

async function registerName() {
    const name = document.getElementById('nickname').value;
    if (!name) return alert("åå‰ã‚’å…¥ã‚Œã¦ã­ï¼");
    await db.collection("users").doc(auth.currentUser.uid).set({ nickname: name });
    myName = name;
    startApp();
}

async function startApp() {
    document.getElementById('overlay').classList.add('hidden');
    document.getElementById('main').classList.remove('hidden');
    document.getElementById('user-info').innerText = `âœ¨ Explorer: ${myName}`;
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        camera.srcObject = stream;
        status.innerText = "äº¤ä¿¡æº–å‚™å®Œäº†";
    } catch(e) {
        status.innerText = "ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ã­ï¼";
    }
}

swapBtn.onclick = async () => {
    swapBtn.disabled = true;
    status.innerText = "æ’®å½±ä¸­...";
    const canvas = document.getElementById('output');
    canvas.width = 300; canvas.height = 400;
    canvas.getContext('2d').drawImage(camera, 0, 0, 300, 400);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.5);

    status.innerText = "èª°ã‹ã‚’æ¢ã—ã¦ã„ã¾ã™...";
    const waitingRooms = await db.collection("waiting").limit(1).get();

    if (waitingRooms.empty) {
        await db.collection("waiting").doc(auth.currentUser.uid).set({
            uid: auth.currentUser.uid, nickname: myName, photoData: dataUrl, time: Date.now()
        });
        const unsubscribe = db.collection("swaps").doc(auth.currentUser.uid).onSnapshot((doc) => {
            if (doc.exists()) {
                const data = doc.data();
                addHistory(data.partnerName, data.partnerPhoto);
                status.innerText = "äº¤ä¿¡æˆåŠŸï¼";
                swapBtn.disabled = false;
                unsubscribe();
            }
        });
        status.innerText = "å¾…æ©Ÿä¸­... èª°ã‹ãŒæ’®ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™";
    } else {
        const partner = waitingRooms.docs[0].data();
        await db.collection("waiting").doc(partner.uid).delete();
        await db.collection("swaps").doc(partner.uid).set({ partnerName: myName, partnerPhoto: dataUrl });
        addHistory(partner.nickname, partner.photoData);
        status.innerText = "äº¤ä¿¡æˆåŠŸï¼";
        swapBtn.disabled = false;
    }
};

function addHistory(name, url) {
    const html = `<div class="card"><span class="name">ğŸš€ ${name}</span><img src="${url}"></div>`;
    document.getElementById('history').insertAdjacentHTML('afterbegin', html);
}
</script>
</body>
</html>
