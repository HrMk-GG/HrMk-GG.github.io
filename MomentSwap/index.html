<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moment Swap - Final Starry Night</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        body { background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%); color: #E2E2E2; font-family: sans-serif; margin: 0; padding-bottom: 50px; min-height: 100vh; text-align: center; overflow-x: hidden; }
        body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: transparent url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/123163/stars.png') repeat; z-index: -1; opacity: 0.4; animation: move-stars 200s linear infinite; }
        @keyframes move-stars { from { background-position: 0 0; } to { background-position: 10000px 5000px; } }
        .hidden { display: none !important; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .btn { background: linear-gradient(45deg, #4fc3f7, #9575cd); color: white; padding: 18px 45px; border-radius: 50px; font-weight: bold; border: none; cursor: pointer; font-size: 1.1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .btn:disabled { background: #555; cursor: not-allowed; }
        video { width: 90%; max-width: 400px; border-radius: 20px; border: 2px solid #4fc3f7; margin-top: 20px; }
        input { padding: 15px; border-radius: 10px; border: 2px solid #4fc3f7; background: #000; color: white; width: 220px; text-align: center; font-size: 1.1rem; outline: none; }
        .card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px; width: 85%; max-width: 380px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); margin: 15px auto; }
        .card img { width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid #333; }
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #4fc3f7; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg) } 100% { transform: rotate(360deg) } }
    </style>
</head>
<body>

<div id="loading-overlay">
    <span class="loader"></span>
    <p>éŠ€æ²³ç³»ã¨é€šä¿¡ä¸­...</p>
</div>

<div id="overlay" class="hidden">
    <div id="login-ui">
        <h1>Moment Swap</h1>
        <p style="color:#4fc3f7">æ˜Ÿç©ºã«å†™çœŸã‚’é€ã‚Šå‡ºãã†</p>
        <button id="login-btn" class="btn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    <div id="name-ui" class="hidden">
        <h2>å®‡å®™ã§ã®åå‰ã‚’æ±ºã‚ã¦ã­</h2>
        <input type="text" id="nickname" maxlength="10" placeholder="åå‰ã‚’å…¥åŠ›">
        <br><br>
        <button id="reg-btn" class="btn" onclick="registerName()">éŠ€æ²³ã¸å‡ºç™º</button>
    </div>
</div>

<div id="main" class="hidden">
    <h1>Moment Swap</h1>
    <video id="camera" autoplay playsinline></video>
    <canvas id="output" class="hidden"></canvas>
    <p id="user-info" style="color:#9575cd; font-weight:bold;"></p>
    <button id="swap-btn" class="btn">ğŸŒŸ ä»Šã‚’æ’®ã£ã¦äº¤æ›ã™ã‚‹</button>
    <p id="status">æº–å‚™ä¸­...</p>
    <div id="history"><h3>å—ä¿¡ã—ãŸæ˜Ÿåº§</h3></div>
</div>

<script>
// --- å›ã®Firebaseè¨­å®š ---
const firebaseConfig = {
  apiKey: "AIzaSyAWVuyKmGKY04Xnpia_2ehtG8fVW5rLX3s",
  authDomain: "photo-share-9405d.firebaseapp.com",
  projectId: "photo-share-9405d",
  storageBucket: "photo-share-9405d.firebasestorage.app",
  messagingSenderId: "218976247260",
  appId: "1:218976247260:web:52f9c93559065317f7c319"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let myName = "";
const loading = document.getElementById('loading-overlay');
const overlay = document.getElementById('overlay');
const loginUI = document.getElementById('login-ui');
const nameUI = document.getElementById('name-ui');
const mainUI = document.getElementById('main');

// --- èªè¨¼ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ ---

// 1. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆçµæœã‚’æœ€å„ªå…ˆã§ãƒã‚§ãƒƒã‚¯
async function checkRedirect() {
    try {
        const result = await auth.getRedirectResult();
        if (result.user) console.log("Redirect Login Success");
    } catch (e) {
        console.error("Auth Error:", e);
    }
}

// 2. ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–ï¼ˆã“ã‚ŒãŒãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ã‚¸ãƒ³ï¼‰
auth.onAuthStateChanged(async (user) => {
    loading.classList.add('hidden'); // çŠ¶æ…‹ãŒåˆ¤æ˜ã—ãŸã‚‰ãƒ­ãƒ¼ãƒ‰ç”»é¢ã‚’æ¶ˆã™
    
    if (user) {
        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«è¦‹ã«è¡Œã
        const doc = await db.collection("users").doc(user.uid).get();
        if (doc.exists()) {
            myName = doc.data().nickname;
            showMain();
        } else {
            // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒãªã„ãªã‚‰åå‰ç™»éŒ²ç”»é¢ã¸
            overlay.classList.remove('hidden');
            loginUI.classList.add('hidden');
            nameUI.classList.remove('hidden');
        }
    } else {
        // æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
        overlay.classList.remove('hidden');
        loginUI.classList.remove('hidden');
        nameUI.classList.add('hidden');
    }
});

// ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
document.getElementById('login-btn').onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithRedirect(provider);
};

// ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç™»éŒ²
async function registerName() {
    const name = document.getElementById('nickname').value;
    if (!name) return alert("åå‰ã‚’å…¥ã‚Œã¦ã­ï¼");
    document.getElementById('reg-btn').disabled = true;
    
    try {
        await db.collection("users").doc(auth.currentUser.uid).set({ nickname: name });
        myName = name;
        showMain();
    } catch (e) {
        alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼ã ãœ: " + e.message);
        document.getElementById('reg-btn').disabled = false;
    }
}

// ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
async function showMain() {
    overlay.classList.add('hidden');
    mainUI.classList.remove('hidden');
    document.getElementById('user-info').innerText = `âœ¨ Explorer: ${myName}`;
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        document.getElementById('camera').srcObject = stream;
        document.getElementById('status').innerText = "äº¤ä¿¡æº–å‚™å®Œäº†";
    } catch(e) {
        document.getElementById('status').innerText = "ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã‚Œï¼";
    }
}

// --- å†™çœŸäº¤æ›ãƒ­ã‚¸ãƒƒã‚¯ ---
document.getElementById('swap-btn').onclick = async () => {
    const btn = document.getElementById('swap-btn');
    const stat = document.getElementById('status');
    const video = document.getElementById('camera');
    const canvas = document.getElementById('output');

    btn.disabled = true;
    stat.innerText = "ç¾åƒä¸­...";

    canvas.width = 300; canvas.height = 400;
    canvas.getContext('2d').drawImage(video, 0, 0, 300, 400);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.5);

    stat.innerText = "éŠ€æ²³ã®å‘ã“ã†ã‚’æ¢ç´¢ä¸­...";
    
    // å¾…æ©Ÿè€…ãƒªã‚¹ãƒˆã‚’ç¢ºèª
    const waitingRooms = await db.collection("waiting").orderBy("time", "asc").limit(1).get();

    if (waitingRooms.empty) {
        // è‡ªåˆ†ãŒå¾…æ©Ÿè€…ã«ãªã‚‹
        await db.collection("waiting").doc(auth.currentUser.uid).set({
            uid: auth.currentUser.uid, nickname: myName, photoData: dataUrl, time: Date.now()
        });
        
        // èª°ã‹ãŒãƒãƒƒãƒãƒ³ã‚°ã—ã¦ãã‚ŒãŸã‹ç›£è¦–
        const unsubscribe = db.collection("swaps").doc(auth.currentUser.uid).onSnapshot((doc) => {
            if (doc.exists()) {
                const data = doc.data();
                addHistory(data.partnerName, data.partnerPhoto);
                stat.innerText = "äº¤ä¿¡æˆåŠŸï¼";
                btn.disabled = false;
                db.collection("swaps").doc(auth.currentUser.uid).delete(); // ã‚´ãƒŸç®±æƒé™¤
                unsubscribe();
            }
        });
        stat.innerText = "äººãŒã„ãªã„ã‚ˆã†ã§ã™... èª°ã‹ãŒæ’®ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...";
    } else {
        // å¾…æ©Ÿè€…ã¨äº¤æ›
        const partner = waitingRooms.docs[0].data();
        await db.collection("waiting").doc(partner.uid).delete();
        await db.collection("swaps").doc(partner.uid).set({
            partnerName: myName, partnerPhoto: dataUrl
        });

        addHistory(partner.nickname, partner.photoData);
        stat.innerText = "äº¤ä¿¡æˆåŠŸï¼";
        btn.disabled = false;
    }
};

function addHistory(name, url) {
    const item = `<div class="card"><span style="color:#4fc3f7">ğŸš€ ${name}</span><img src="${url}"></div>`;
    document.getElementById('history').insertAdjacentHTML('afterbegin', item);
}

// å…¨ã¦ã‚’é–‹å§‹
checkRedirect();
</script>
</body>
</html>
