<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moment Swap - Starry Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            color: #E2E2E2; font-family: sans-serif; margin: 0; padding-bottom: 50px;
            min-height: 100vh; text-align: center; overflow-x: hidden;
        }
        /* æ˜Ÿå±‘ã®èƒŒæ™¯ */
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: transparent url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/123163/stars.png') repeat;
            z-index: -1; opacity: 0.4; animation: move-stars 200s linear infinite;
        }
        @keyframes move-stars { from { background-position: 0 0; } to { background-position: 10000px 5000px; } }
        
        .hidden { display: none !important; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(10px); }
        
        video { width: 90%; max-width: 400px; border-radius: 20px; border: 2px solid #4fc3f7; margin-top: 20px; box-shadow: 0 0 20px rgba(79,195,247,0.3); }
        .btn { background: linear-gradient(45deg, #4fc3f7, #9575cd); color: white; padding: 18px 40px; border-radius: 50px; font-weight: bold; border: none; cursor: pointer; font-size: 1.1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { background: #555; cursor: not-allowed; }
        
        input { padding: 15px; border-radius: 10px; border: 2px solid #4fc3f7; background: #000; color: white; width: 200px; text-align: center; font-size: 1.1rem; }
        .card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px; width: 85%; max-width: 380px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); margin: 15px auto; }
        .card img { width: 100%; border-radius: 10px; margin-top: 10px; }
        .name { color: #4fc3f7; font-weight: bold; }
    </style>
</head>
<body>

<div id="overlay" class="hidden">
    <div id="login-ui">
        <h1>Moment Swap</h1>
        <p style="color:#4fc3f7">æ˜Ÿç©ºã«å†™çœŸã‚’é€ã‚Šå‡ºãã†</p>
        <button id="login-btn" class="btn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <p id="l-status" style="font-size:0.8rem; margin-top:10px;"></p>
    </div>
    <div id="name-ui" class="hidden">
        <h2>å®‡å®™ã§ã®åå‰ã¯ï¼Ÿ</h2>
        <input type="text" id="nickname" maxlength="10" placeholder="åå‰ã‚’å…¥åŠ›">
        <br><br>
        <button class="btn" onclick="registerName()">éŠ€æ²³ã¸å‡ºç™º</button>
    </div>
</div>

<div id="main" class="hidden">
    <h1 style="text-shadow: 0 0 10px #4fc3f7;">Moment Swap</h1>
    <video id="camera" autoplay playsinline></video>
    <canvas id="output" class="hidden"></canvas>
    <p id="user-info" style="color:#9575cd"></p>
    <button id="swap-btn" class="btn">ğŸŒŸ ä»Šã‚’æ’®ã£ã¦äº¤æ›ã™ã‚‹</button>
    <p id="status">æº–å‚™ä¸­...</p>
    <div id="history"><h3>å—ä¿¡ã—ãŸæ˜Ÿåº§</h3></div>
</div>

<script>
// --- å›ã®Firebaseè¨­å®š ---
const firebaseConfig = {
  apiKey: "AIzaSyAWVuyKmGKY04Xnpia_2ehtG8fVW5rLX3s",
  authDomain: "photo-share-9405d.firebaseapp.com",
  projectId: "photo-share-9405d",
  storageBucket: "photo-share-9405d.firebasestorage.app",
  messagingSenderId: "218976247260",
  appId: "1:218976247260:web:52f9c93559065317f7c319"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let myName = "";
const overlay = document.getElementById('overlay');
const loginUI = document.getElementById('login-ui');
const nameUI = document.getElementById('name-ui');
const mainUI = document.getElementById('main');
const lStatus = document.getElementById('l-status');

// 1. ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
document.getElementById('login-btn').onclick = () => {
    lStatus.innerText = "èªè¨¼ç”»é¢ã¸ã‚¸ãƒ£ãƒ³ãƒ—ä¸­...";
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithRedirect(provider);
};

// 2. ãƒ­ã‚°ã‚¤ãƒ³çµæœã®å—ã‘å–ã‚Šã¨çŠ¶æ…‹ç›£è¦–
async function init() {
    try {
        // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‹ã‚‰æˆ»ã£ã¦ããŸçµæœã‚’ç¢ºèª
        const result = await auth.getRedirectResult();
        if (result.user) console.log("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ");
    } catch (e) {
        console.error("ã‚¨ãƒ©ãƒ¼:", e);
        lStatus.innerText = "ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãœã€‚";
    }

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const doc = await db.collection("users").doc(user.uid).get();
            if (doc.exists()) {
                myName = doc.data().nickname;
                showApp();
            } else {
                overlay.classList.remove('hidden');
                loginUI.classList.add('hidden');
                nameUI.classList.remove('hidden');
            }
        } else {
            overlay.classList.remove('hidden');
            loginUI.classList.remove('hidden');
            nameUI.classList.add('hidden');
        }
    });
}

async function registerName() {
    const name = document.getElementById('nickname').value;
    if (!name) return alert("åå‰ã‚’å…¥ã‚Œã¦ã­ï¼");
    await db.collection("users").doc(auth.currentUser.uid).set({ nickname: name });
    myName = name;
    showApp();
}

async function showApp() {
    overlay.classList.add('hidden');
    mainUI.classList.remove('hidden');
    document.getElementById('user-info').innerText = `âœ¨ Explorer: ${myName}`;
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        document.getElementById('camera').srcObject = stream;
        document.getElementById('status').innerText = "äº¤ä¿¡æº–å‚™å®Œäº†";
    } catch(e) {
        document.getElementById('status').innerText = "ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã‚Œï¼";
    }
}

// 3. å†™çœŸäº¤æ›ãƒ­ã‚¸ãƒƒã‚¯
document.getElementById('swap-btn').onclick = async () => {
    const btn = document.getElementById('swap-btn');
    const stat = document.getElementById('status');
    btn.disabled = true;
    stat.innerText = "æ’®å½±ä¸­...";

    const canvas = document.getElementById('output');
    const video = document.getElementById('camera');
    canvas.width = 300; canvas.height = 400;
    canvas.getContext('2d').drawImage(video, 0, 0, 300, 400);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.5);

    stat.innerText = "ä¿¡å·ã‚’é€ä¿¡ä¸­...";
    const waitingRooms = await db.collection("waiting").limit(1).get();

    if (waitingRooms.empty) {
        await db.collection("waiting").doc(auth.currentUser.uid).set({
            uid: auth.currentUser.uid, nickname: myName, photoData: dataUrl, time: Date.now()
        });
        const unsubscribe = db.collection("swaps").doc(auth.currentUser.uid).onSnapshot((doc) => {
            if (doc.exists()) {
                const data = doc.data();
                addHistory(data.partnerName, data.partnerPhoto);
                stat.innerText = "äº¤ä¿¡æˆåŠŸï¼";
                btn.disabled = false;
                unsubscribe();
            }
        });
        stat.innerText = "äººãŒã„ã¾ã›ã‚“...ï¼ˆå¾…æ©Ÿä¸­ï¼‰";
    } else {
        const partner = waitingRooms.docs[0].data();
        await db.collection("waiting").doc(partner.uid).delete();
        await db.collection("swaps").doc(partner.uid).set({ partnerName: myName, partnerPhoto: dataUrl });
        addHistory(partner.nickname, partner.photoData);
        stat.innerText = "äº¤ä¿¡æˆåŠŸï¼";
        btn.disabled = false;
    }
};

function addHistory(name, url) {
    const item = `<div class="card"><span class="name">ğŸš€ ${name}</span><img src="${url}"></div>`;
    document.getElementById('history').insertAdjacentHTML('afterbegin', item);
}

init();
</script>
</body>
</html>
