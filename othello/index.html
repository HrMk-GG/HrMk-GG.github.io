<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥µãƒ»ã‚ªã‚»ãƒ­ PREMIER</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #6366f1; --accent: #a855f7; --bg: #0f172a;
            --glass: rgba(255, 255, 255, 0.05); --board-color: #1e293b;
        }
        /* 10ç¨®é¡ã®ãƒ†ãƒ¼ãƒè¨­å®š */
        body.theme-dark { --board-color: #1e293b; }
        body.theme-classic { --board-color: #2e7d32; }
        body.theme-midnight { --board-color: #020617; }
        body.theme-ocean { --board-color: #075985; }
        body.theme-forest { --board-color: #064e3b; }
        body.theme-crimson { --board-color: #7f1d1d; }
        body.theme-amber { --board-color: #78350f; }
        body.theme-grape { --board-color: #581c87; }
        body.theme-slate { --board-color: #1e293b; }
        body.theme-gold { --board-color: #713f12; }

        body {
            background: radial-gradient(circle at top left, #1e1b4b, var(--bg));
            color: #f8fafc; font-family: 'Hiragino Sans', sans-serif;
            margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden;
        }
        .glass-card {
            background: var(--glass); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px;
            padding: 30px; width: 90%; max-width: 400px; text-align: center; position: relative;
        }
        #version-display { position: fixed; top: 10px; right: 10px; background: var(--glass); padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; color: rgba(255,255,255,0.7); border: 1px solid rgba(255,255,255,0.1); z-index: 2000; pointer-events: none; }
        button {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; border: none; padding: 12px; font-size: 0.9rem; font-weight: bold;
            border-radius: 12px; cursor: pointer; width: 100%; margin: 5px 0; transition: 0.3s;
        }
        button:hover { transform: translateY(-1px); filter: brightness(1.1); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        input, select {
            background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; padding: 10px; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; text-align: center;
        }
        .board {
            display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px;
            background: rgba(255, 255, 255, 0.05); padding: 8px; border-radius: 12px; margin: 15px 0; aspect-ratio: 1/1;
        }
        .cell { background: var(--board-color); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .stone { width: 85%; height: 85%; border-radius: 50%; transform: scale(0); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .stone.black { display: block; background: #000; transform: scale(1); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .stone.white { display: block; background: #fff; transform: scale(1); box-shadow: 0 4px 10px rgba(255,255,255,0.3); }
        .hidden { display: none !important; }
        .status-badge { background: var(--glass); padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 10px; }
        label { display: block; font-size: 0.8rem; margin-top: 10px; text-align: left; color: rgba(255,255,255,0.6); }
    </style>
</head>
<body class="theme-dark">

    <div id="version-display">Build: Loading...</div>

    <div class="glass-card">
        <div id="sc-login">
            <h1>æ¥µãƒ»ã‚ªã‚»ãƒ­</h1>
            <input type="text" id="in-name" placeholder="åå‰ã‚’å…¥åŠ›">
            <button onclick="toMenu()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>

        <div id="sc-menu" class="hidden">
            <div class="status-badge">Player: <span id="disp-name"></span></div>
            <button onclick="startCPU()">CPUæˆ¦ï¼ˆç·´ç¿’ï¼‰</button>
            <button onclick="changeScreen('sc-online')">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</button>
            <button onclick="changeScreen('sc-set')">è¨­å®š</button>
        </div>

        <div id="sc-set" class="hidden">
            <h2>è¨­å®š</h2>
            <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¤‰æ›´</label>
            <input type="text" id="edit-name" onchange="updateNick()">
            <label>ç›¤é¢ãƒ†ãƒ¼ãƒ</label>
            <select id="theme-sel" onchange="updateTheme()">
                <option value="theme-dark">ãƒ€ãƒ¼ã‚¯ï¼ˆæ¨™æº–ï¼‰</option>
                <option value="theme-classic">ã‚¯ãƒ©ã‚·ãƒƒã‚¯ï¼ˆç·‘ï¼‰</option>
                <option value="theme-midnight">ãƒŸãƒƒãƒ‰ãƒŠã‚¤ãƒˆ</option>
                <option value="theme-ocean">ã‚ªãƒ¼ã‚·ãƒ£ãƒ³</option>
                <option value="theme-forest">ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ</option>
                <option value="theme-crimson">ã‚¯ãƒªãƒ ã‚¾ãƒ³</option>
                <option value="theme-amber">ã‚¢ãƒ³ãƒãƒ¼</option>
                <option value="theme-grape">ã‚°ãƒ¬ãƒ¼ãƒ—</option>
                <option value="theme-slate">ã‚¹ãƒ¬ãƒ¼ãƒˆ</option>
                <option value="theme-gold">ã‚´ãƒ¼ãƒ«ãƒ‰</option>
            </select>
            <label>åŠ¹æœéŸ³</label>
            <button id="btn-se" onclick="toggleSE()" style="background:var(--glass)">SE: ON</button>
            <button onclick="changeScreen('sc-menu')">æˆ»ã‚‹</button>
        </div>

        <div id="sc-online" class="hidden">
            <h2>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</h2>
            <button onclick="createRoom()">éƒ¨å±‹ã‚’ä½œã‚‹</button>
            <input type="text" id="in-room" placeholder="5æ¡ã‚³ãƒ¼ãƒ‰">
            <button onclick="joinRoom()">å‚åŠ ã™ã‚‹</button>
            <p id="wait-msg"></p>
            <button onclick="changeScreen('sc-menu')" style="background:var(--glass)">æˆ»ã‚‹</button>
        </div>

        <div id="sc-jan" class="hidden">
            <h2>å…ˆæ”»æ±ºã‚</h2>
            <p id="jan-info">æ‰‹ã‚’é¸ã‚“ã§ã­ï¼</p>
            <div style="display:flex; gap:10px;">
                <button class="j-btn" onclick="setJan(0)">âœŠ</button>
                <button class="j-btn" onclick="setJan(1)">âœŒï¸</button>
                <button class="j-btn" onclick="setJan(2)">ğŸ–ï¸</button>
            </div>
        </div>

        <div id="sc-game" class="hidden">
            <div class="status-badge" id="turn-txt">æº–å‚™ä¸­...</div>
            <div id="board" class="board"></div>
            <div style="display:flex; justify-content:space-around; font-size:0.9rem;">
                <span>é»’: <b id="cnt-b">2</b></span>
                <span>ç™½: <b id="cnt-w">2</b></span>
            </div>
            <button onclick="location.reload()" style="margin-top:10px; background:var(--glass)">çµ‚äº†</button>
        </div>
    </div>

    <audio id="se-put" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

    <script>
        // --- ãƒ“ãƒ«ãƒ‰æ—¥æ™‚è‡ªå‹•è¡¨ç¤º ---
        window.addEventListener('load', () => {
            const lastMod = new Date(document.lastModified);
            const dateStr = `${lastMod.getMonth()+1}/${lastMod.getDate()} ${lastMod.getHours()}:${String(lastMod.getMinutes()).padStart(2,'0')}`;
            document.getElementById('version-display').innerText = "Build: " + dateStr;
        });

        // --- Firebaseè¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyBYb9uXyjA7XJdRiYjcA3VBlSVgLh0C1fw",
            authDomain: "hrmk-othello.firebaseapp.com",
            projectId: "hrmk-othello",
            databaseURL: "https://hrmk-othello-default-rtdb.asia-southeast1.firebasedatabase.app/",
            storageBucket: "hrmk-othello.firebasestorage.app",
            messagingSenderId: "91127278693",
            appId: "1:91127278693:web:89d6cdbbcabac60a172a8c"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName = "", mySide = 'black', turn = 'black', mode = 'cpu', roomID = "", myRole = "", seEnabled = true;
        let boardState = Array(64).fill(null);

        function changeScreen(id) {
            document.querySelectorAll('.glass-card > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function toMenu() {
            myName = document.getElementById('in-name').value || "ãªãªã—";
            document.getElementById('disp-name').innerText = myName;
            document.getElementById('edit-name').value = myName;
            changeScreen('sc-menu');
        }

        // --- è¨­å®šç®¡ç† ---
        function updateNick() {
            myName = document.getElementById('edit-name').value;
            document.getElementById('disp-name').innerText = myName;
        }
        function updateTheme() {
            document.body.className = document.getElementById('theme-sel').value;
        }
        function toggleSE() {
            seEnabled = !seEnabled;
            document.getElementById('btn-se').innerText = `SE: ${seEnabled ? 'ON' : 'OFF'}`;
        }
        function playSE() {
            if (seEnabled) {
                const audio = document.getElementById('se-put');
                audio.currentTime = 0; audio.play().catch(()=>{});
            }
        }

        // --- ãƒãƒƒãƒãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ ---
        function createRoom() {
            roomID = Math.random().toString(36).substring(2, 7).toUpperCase();
            myRole = 'host';
            db.ref('rooms/' + roomID).set({ status: 'wait', hostName: myName });
            document.getElementById('wait-msg').innerHTML = `ã‚³ãƒ¼ãƒ‰: <b style="color:#a855f7;">${roomID}</b><br>å¾…æ©Ÿä¸­...`;
            db.ref('rooms/' + roomID).on('value', s => {
                const data = s.val();
                if (data?.status === 'ready') changeScreen('sc-jan');
                if (data?.status === 'play') syncGame(data);
            });
        }

        function joinRoom() {
            roomID = document.getElementById('in-room').value.toUpperCase();
            if (!roomID) return;
            myRole = 'guest';
            db.ref('rooms/' + roomID).update({ status: 'ready', guestName: myName });
            changeScreen('sc-jan');
            db.ref('rooms/' + roomID).on('value', s => {
                if (s.val()?.status === 'play') syncGame(s.val());
            });
        }

        function setJan(hand) {
            db.ref(`rooms/${roomID}/jan/${myRole}`).set(hand);
            document.getElementById('jan-info').innerText = "ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...";
            document.querySelectorAll('.j-btn').forEach(b => b.disabled = true);
            
            db.ref(`rooms/${roomID}/jan`).on('value', s => {
                const hands = s.val();
                if (hands && hands.host !== undefined && hands.guest !== undefined) {
                    if (hands.host === hands.guest) {
                        document.getElementById('jan-info').innerText = "ã‚ã„ã“ï¼";
                        document.querySelectorAll('.j-btn').forEach(b => b.disabled = false);
                        if (myRole === 'host') db.ref(`rooms/${roomID}/jan`).remove();
                    } else {
                        const hostWins = (hands.host===0 && hands.guest===1) || (hands.host===1 && hands.guest===2) || (hands.host===2 && hands.guest===0);
                        mySide = (myRole === 'host') ? (hostWins ? 'black' : 'white') : (hostWins ? 'white' : 'black');
                        if (myRole === 'host') {
                            db.ref('rooms/' + roomID).update({ status: 'play', turn: 'black', board: JSON.stringify(initBoard()) });
                        }
                    }
                }
            });
        }

        // --- ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ ---
        function initBoard() {
            let b = Array(64).fill(null); b[27]='white'; b[28]='black'; b[35]='black'; b[36]='white'; return b;
        }

        function startCPU() {
            mode = 'cpu'; mySide = 'black'; boardState = initBoard(); turn = 'black';
            changeScreen('sc-game'); render();
        }

        function syncGame(data) {
            mode = 'online'; boardState = JSON.parse(data.board);
            if (turn !== data.turn) playSE();
            turn = data.turn; changeScreen('sc-game'); render();
            checkPass();
        }

        function render() {
            const b = document.getElementById('board'); b.innerHTML = "";
            let bc=0, wc=0;
            boardState.forEach((s, i) => {
                const c = document.createElement('div'); c.className = 'cell';
                const st = document.createElement('div'); st.className = 'stone ' + (s || '');
                if(s==='black') bc++; if(s==='white') wc++;
                c.onclick = () => clickCell(i);
                c.appendChild(st); b.appendChild(c);
            });
            document.getElementById('cnt-b').innerText = bc; document.getElementById('cnt-w').innerText = wc;
            document.getElementById('turn-txt').innerText = (turn === 'black' ? "é»’" : "ç™½") + "ã®ç•ª" + (turn === mySide ? " (ã‚ãªãŸ)" : "");
        }

        function clickCell(i) {
            if (mode === 'online' && turn !== mySide) return;
            if (boardState[i]) return;

            const flips = getFlips(i, turn);
            if (flips.length > 0) {
                boardState[i] = turn;
                flips.forEach(idx => boardState[idx] = turn);
                playSE();
                const nextTurn = (turn === 'black' ? 'white' : 'black');
                
                if (mode === 'online') {
                    db.ref('rooms/' + roomID).update({ board: JSON.stringify(boardState), turn: nextTurn });
                } else {
                    turn = nextTurn; render();
                    if (turn === 'white') setTimeout(cpuPlay, 600);
                    else checkPass();
                }
            }
        }

        function checkPass() {
            const moves = [];
            boardState.forEach((s, i) => { if(!s && getFlips(i, turn).length > 0) moves.push(i); });
            if (moves.length === 0) {
                const opp = (turn === 'black' ? 'white' : 'black');
                const oppMoves = [];
                boardState.forEach((s, i) => { if(!s && getFlips(i, opp).length > 0) oppMoves.push(i); });
                
                if (oppMoves.length > 0) {
                    alert(turn === 'black' ? "é»’ãƒ‘ã‚¹ï¼" : "ç™½ãƒ‘ã‚¹ï¼");
                    if (mode === 'online') db.ref('rooms/' + roomID).update({ turn: opp });
                    else { turn = opp; render(); if(turn==='white') setTimeout(cpuPlay,600); }
                } else {
                    const bc = boardState.filter(s=>s==='black').length;
                    const wc = boardState.filter(s=>s==='white').length;
                    alert(`è©¦åˆçµ‚äº†ï¼\né»’: ${bc} ç™½: ${wc}\n${bc>wc?"é»’":"ç™½"}ã®å‹ã¡ï¼`);
                }
            }
        }

        function getFlips(idx, color) {
            const opp = (color === 'black' ? 'white' : 'black');
            const flips = [];
            const dirs = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
            const r = Math.floor(idx/8), c = idx%8;
            dirs.forEach(([dr, dc]) => {
                let tr=r+dr, tc=c+dc, temp=[];
                while(tr>=0 && tr<8 && tc>=0 && tc<8 && boardState[tr*8+tc] === opp) { temp.push(tr*8+tc); tr+=dr; tc+=dc; }
                if(tr>=0 && tr<8 && tc>=0 && tc<8 && boardState[tr*8+tc] === color) flips.push(...temp);
            });
            return flips;
        }

        function cpuPlay() {
            let moves = [];
            boardState.forEach((s, i) => { if(!s && getFlips(i, 'white').length > 0) moves.push(i); });
            if (moves.length > 0) {
                const move = moves[Math.floor(Math.random() * moves.length)];
                boardState[move] = 'white';
                getFlips(move, 'white').forEach(idx => boardState[idx] = 'white');
                playSE(); turn = 'black'; render(); checkPass();
            } else {
                turn = 'black'; render(); checkPass();
            }
        }
    </script>
</body>
</html>
