<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥µãƒ»ã‚ªã‚»ãƒ­ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ </title>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #6366f1; --accent: #a855f7; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); --board-color: #1e293b; }
        body { background: radial-gradient(circle at top left, #1e1b4b, var(--bg)); color: #f8fafc; font-family: sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .glass-card { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 30px; width: 90%; max-width: 400px; text-align: center; }
        h1 { background: linear-gradient(to right, #818cf8, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        button { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border: none; padding: 14px; font-size: 1rem; font-weight: bold; border-radius: 12px; cursor: pointer; width: 100%; margin: 8px 0; transition: 0.3s; }
        button:disabled { filter: grayscale(1); cursor: not-allowed; }
        input { background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 15px; text-align: center; }
        .board { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; background: rgba(255, 255, 255, 0.05); padding: 8px; border-radius: 12px; margin: 20px 0; aspect-ratio: 1/1; }
        .cell { background: var(--board-color); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; aspect-ratio: 1/1; }
        .stone { width: 85%; height: 85%; border-radius: 50%; transform: scale(0); transition: 0.4s; }
        .black { display: block; background: #000; transform: scale(1); box-shadow: 0 0 10px #000; }
        .white { display: block; background: #fff; transform: scale(1); box-shadow: 0 0 10px #fff; }
        .hidden { display: none !important; }
        .status-badge { background: var(--glass); padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="glass-card">
        <div id="sc-login">
            <h1>æ¥µãƒ»ã‚ªã‚»ãƒ­</h1>
            <input type="text" id="in-name" placeholder="åå‰ã‚’å…¥åŠ›">
            <button onclick="toMenu()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        </div>

        <div id="sc-menu" class="hidden">
            <div class="status-badge"><span id="disp-name"></span> ã•ã‚“</div>
            <button onclick="startCPU()">CPUå¯¾æˆ¦</button>
            <button onclick="changeScreen('sc-online')">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</button>
            <button onclick="changeScreen('sc-set')">è¨­å®š</button>
        </div>

        <div id="sc-online" class="hidden">
            <h1>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</h1>
            <button onclick="createRoom()">éƒ¨å±‹ã‚’ä½œã‚‹</button>
            <input type="text" id="in-room" placeholder="5æ¡ã‚³ãƒ¼ãƒ‰">
            <button onclick="joinRoom()">å‚åŠ ã™ã‚‹</button>
            <p id="wait-msg"></p>
            <button onclick="changeScreen('sc-menu')" style="background:var(--glass)">æˆ»ã‚‹</button>
        </div>

        <div id="sc-jan" class="hidden">
            <h1>å…ˆæ”»æ±ºã‚</h1>
            <p id="jan-info">å‡ºã™æ‰‹ã‚’é¸ã‚“ã§ã­ï¼</p>
            <div style="display:flex; gap:10px;">
                <button class="j-btn" onclick="setJan(0)">âœŠ</button>
                <button class="j-btn" onclick="setJan(1)">âœŒï¸</button>
                <button class="j-btn" onclick="setJan(2)">ğŸ–ï¸</button>
            </div>
        </div>

        <div id="sc-game" class="hidden">
            <div class="status-badge" id="turn-txt">é»’ã®ç•ª</div>
            <div id="board" class="board"></div>
            <div style="display:flex; justify-content:space-around;">
                <span>é»’: <b id="cnt-b">2</b></span>
                <span>ç™½: <b id="cnt-w">2</b></span>
            </div>
            <button onclick="location.reload()" style="margin-top:10px; background:var(--glass)">çµ‚äº†</button>
        </div>

        <div id="sc-set" class="hidden">
            <h1>è¨­å®š</h1>
            <input type="color" id="col-pick" value="#1e293b" onchange="upCol()">
            <button onclick="changeScreen('sc-menu')">æˆ»ã‚‹</button>
        </div>
    </div>

<script>
    // FirebaseåˆæœŸåŒ–ï¼ˆè¨­å®šã¯ãã®ã¾ã¾ï¼‰
    const firebaseConfig = {
        apiKey: "AIzaSyBYb9uXyjA7XJdRiYjcA3VBlSVgLh0C1fw",
        authDomain: "hrmk-othello.firebaseapp.com",
        projectId: "hrmk-othello",
        databaseURL: "https://hrmk-othello-default-rtdb.firebaseio.com",
        storageBucket: "hrmk-othello.firebasestorage.app",
        messagingSenderId: "91127278693",
        appId: "1:91127278693:web:89d6cdbbcabac60a172a8c"
    };
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    let myName = "", mySide = 'black', turn = 'black', mode = 'cpu', roomID = "", myRole = "";
    let boardState = Array(64).fill(null);

    function changeScreen(id) {
        document.querySelectorAll('.glass-card > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function toMenu() {
        myName = document.getElementById('in-name').value || "ãªãªã—";
        document.getElementById('disp-name').innerText = myName;
        changeScreen('sc-menu');
    }

    // --- ã€é‡è¦ã€‘ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒƒãƒãƒ³ã‚°ä¿®æ­£ ---

    // 1. éƒ¨å±‹ã‚’ä½œã‚‹ï¼ˆãƒ›ã‚¹ãƒˆï¼‰
    function createRoom() {
        roomID = Math.random().toString(36).substring(2, 7).toUpperCase();
        myRole = 'host';
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
        const roomRef = db.ref('rooms/' + roomID);
        roomRef.set({
            status: 'wait',
            hostName: myName,
            turn: 'black'
        });

        document.getElementById('wait-msg').innerHTML = `ã‚³ãƒ¼ãƒ‰: <b style="font-size:1.5rem; color:#a855f7;">${roomID}</b><br>ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...`;
        
        // ç›¸æ‰‹ãŒæ¥ã‚‹ã®ã‚’ç›£è¦–
        roomRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data && data.status === 'ready') {
                console.log("ã‚²ã‚¹ãƒˆãŒæ¥ãŸã‚ˆï¼ã˜ã‚ƒã‚“ã‘ã‚“ã¸é€²ã¿ã¾ã™");
                changeScreen('sc-jan');
            }
            if (data && data.status === 'play') {
                syncGame(data);
            }
        });
    }

    // 2. éƒ¨å±‹ã«å…¥ã‚‹ï¼ˆã‚²ã‚¹ãƒˆï¼‰
    function joinRoom() {
        roomID = document.getElementById('in-room').value.toUpperCase();
        if (!roomID) return alert("ã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ã­ï¼");
        myRole = 'guest';

        const roomRef = db.ref('rooms/' + roomID);
        
        // éƒ¨å±‹ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰å…¥ã‚‹
        roomRef.once('value').then((snapshot) => {
            if (snapshot.exists()) {
                roomRef.update({
                    status: 'ready',
                    guestName: myName
                });
                changeScreen('sc-jan');
                
                // ã‚²ãƒ¼ãƒ æ›´æ–°ã‚’ç›£è¦–
                roomRef.on('value', (s) => {
                    const data = s.val();
                    if (data && data.status === 'play') syncGame(data);
                });
            } else {
                alert("ãã®ã‚³ãƒ¼ãƒ‰ã®éƒ¨å±‹ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆï¼ğŸ˜¢");
            }
        });
    }

    // --- ã˜ã‚ƒã‚“ã‘ã‚“åˆ¤å®š ---
    function setJan(hand) {
        const janRef = db.ref(`rooms/${roomID}/jan/${myRole}`);
        janRef.set(hand);
        
        document.getElementById('jan-info').innerText = "ç›¸æ‰‹ã®æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...";
        document.querySelectorAll('.j-btn').forEach(b => b.disabled = true);
        
        db.ref(`rooms/${roomID}/jan`).on('value', s => {
            const hands = s.val();
            if (hands && hands.host !== undefined && hands.guest !== undefined) {
                const h = hands.host;
                const g = hands.guest;
                
                if (h === g) {
                    document.getElementById('jan-info').innerText = "ã‚ã„ã“ï¼ã‚‚ã†ä¸€å›ï¼";
                    document.querySelectorAll('.j-btn').forEach(b => b.disabled = false);
                    if (myRole === 'host') db.ref(`rooms/${roomID}/jan`).remove(); // ãƒ›ã‚¹ãƒˆãŒãƒªã‚»ãƒƒãƒˆ
                } else {
                    const hostWins = (h === 0 && g === 1) || (h === 1 && g === 2) || (h === 2 && g === 0);
                    
                    // å‹æ•—ã§è‰²ï¼ˆå…ˆæ”»å¾Œæ”»ï¼‰ã‚’æ±ºã‚ã‚‹
                    if (myRole === 'host') {
                        mySide = hostWins ? 'black' : 'white';
                        // ãƒ›ã‚¹ãƒˆå´ãŒã‚²ãƒ¼ãƒ é–‹å§‹ã®åˆå›³ã‚’å‡ºã™
                        db.ref('rooms/' + roomID).update({
                            status: 'play',
                            turn: 'black',
                            board: JSON.stringify(initBoard())
                        });
                    } else {
                        mySide = hostWins ? 'white' : 'black';
                    }
                }
            }
        });
    }

    // 3. ã‚²ãƒ¼ãƒ åŒæœŸ
    function syncGame(data) {
        mode = 'online';
        boardState = JSON.parse(data.board);
        turn = data.turn;
        changeScreen('sc-game');
        render();
    }

    // --- ãã®ä»–ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå‰ã¨åŒã˜ï¼‰ ---
    function initBoard() {
        let b = Array(64).fill(null);
        b[27]='white'; b[28]='black'; b[35]='black'; b[36]='white';
        return b;
    }

    function render() {
        const b = document.getElementById('board'); b.innerHTML = "";
        let bc=0, wc=0;
        boardState.forEach((s, i) => {
            const c = document.createElement('div'); c.className = 'cell';
            const st = document.createElement('div'); st.className = 'stone ' + (s || '');
            if(s==='black') bc++; if(s==='white') wc++;
            c.onclick = () => clickCell(i);
            c.appendChild(st); b.appendChild(c);
        });
        document.getElementById('cnt-b').innerText = bc;
        document.getElementById('cnt-w').innerText = wc;
        document.getElementById('turn-txt').innerText = (turn === 'black' ? "é»’" : "ç™½") + "ã®ç•ª" + (turn === mySide ? " (ã‚ãªãŸ)" : " (ç›¸æ‰‹)");
    }

    function clickCell(i) {
        if (turn !== mySide || boardState[i]) return;
        const flips = getFlips(i, turn);
        if (flips.length > 0) {
            boardState[i] = turn;
            flips.forEach(idx => boardState[idx] = turn);
            const nextTurn = (turn === 'black' ? 'white' : 'black');
            if (mode === 'online') {
                db.ref('rooms/' + roomID).update({ board: JSON.stringify(boardState), turn: nextTurn });
            }
        }
    }

    function getFlips(idx, color) {
        const opp = (color === 'black' ? 'white' : 'black');
        const flips = [];
        const dirs = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
        const r = Math.floor(idx/8), c = idx%8;
        dirs.forEach(([dr, dc]) => {
            let tr=r+dr, tc=c+dc, temp=[];
            while(tr>=0 && tr<8 && tc>=0 && tc<8 && boardState[tr*8+tc] === opp) { temp.push(tr*8+tc); tr+=dr; tc+=dc; }
            if(tr>=0 && tr<8 && tc>=0 && tc<8 && boardState[tr*8+tc] === color) flips.push(...temp);
        });
        return flips;
    }
</script>
</body>
</html>
