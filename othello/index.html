<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥µãƒ»ã‚ªã‚»ãƒ­ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</title>
    <script type="importmap">
    {
        "imports": {
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"
        }
    }
    </script>
    <style>
        :root { --bg-color: #2c3e50; --board-color: #27ae60; }
        body { background-color: var(--bg-color); color: white; font-family: 'Hiragino Sans', sans-serif; text-align: center; margin: 0; transition: 0.3s; }
        .hidden { display: none; }
        .screen { padding: 20px; animation: fadeIn 0.5s; min-height: 80vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        button { background: #ecf0f1; border: none; padding: 12px 24px; margin: 8px; font-size: 18px; cursor: pointer; border-radius: 8px; font-weight: bold; }
        button:hover { background: #bdc3c7; transform: translateY(-2px); }
        input[type="text"] { padding: 12px; font-size: 18px; border-radius: 8px; border: none; width: 240px; text-align: center; margin: 10px; }
        
        /* ç›¤é¢ */
        .board { display: grid; grid-template-columns: repeat(8, 1fr); gap: 2px; background: #34495e; border: 5px solid #34495e; margin: 20px auto; width: 320px; height: 320px; }
        .cell { background: var(--board-color); display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .stone { width: 85%; height: 85%; border-radius: 50%; display: none; transition: 0.3s transform; }
        .black { display: block; background: #000; box-shadow: 2px 2px 4px rgba(0,0,0,0.4); }
        .white { display: block; background: #fff; box-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .valid-hint::after { content: ""; width: 10px; height: 10px; background: rgba(255,255,255,0.3); border-radius: 50%; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .matching-loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="screen-nick" class="screen">
        <h1>âšªï¸ æ¥µãƒ»ã‚ªã‚»ãƒ­ âš«ï¸</h1>
        <p>åå‰ã‚’æ±ºã‚ã¦ã­ (10æ–‡å­—ä»¥å†…)</p>
        <input type="text" id="nick-input" maxlength="10" placeholder="ãªã¾ãˆ">
        <button id="nick-btn">æ±ºå®šï¼</button>
    </div>

    <div id="screen-menu" class="screen hidden">
        <h2>ã‚ˆã†ã“ãã€<span id="name-display"></span> ã•ã‚“ï¼</h2>
        <button id="btn-cpu-menu">CPUå¯¾æˆ¦</button>
        <button id="btn-online-menu">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</button>
        <button id="btn-settings-menu">è¨­å®š</button>
    </div>

    <div id="screen-cpu-lv" class="screen hidden">
        <h2>ãƒ¬ãƒ™ãƒ«ã‚’é¸ã‚“ã§ã­</h2>
        <button onclick="startGame('cpu', 'weak')">å¼±ã„</button>
        <button onclick="startGame('cpu', 'normal')">æ™®é€š</button>
        <button onclick="startGame('cpu', 'strong')">å¼·ã„</button>
        <button class="back-btn">ã‚‚ã©ã‚‹</button>
    </div>

    <div id="screen-online" class="screen hidden">
        <h2>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</h2>
        <button id="btn-create-room">éƒ¨å±‹ã‚’ä½œæˆ</button>
        <p>ã¾ãŸã¯</p>
        <input type="text" id="room-input" maxlength="5" placeholder="5æ¡ã‚³ãƒ¼ãƒ‰å…¥åŠ›">
        <button id="btn-join-room">éƒ¨å±‹ã«å‚åŠ </button>
        <p id="online-status"></p>
        <button class="back-btn">ã‚‚ã©ã‚‹</button>
    </div>

    <div id="screen-janken" class="screen hidden">
        <h2 id="janken-status">ã˜ã‚ƒã‚“ã‘ã‚“ï¼</h2>
        <div>
            <button onclick="sendJanken('goo')">âœŠ</button>
            <button onclick="sendJanken('choki')">âœŒï¸</button>
            <button onclick="sendJanken('paa')">ğŸ–ï¸</button>
        </div>
        <p id="janken-msg"></p>
    </div>

    <div id="screen-game" class="screen hidden">
        <div id="turn-display" style="font-size: 20px; margin-bottom: 10px;"></div>
        <div class="board" id="board"></div>
        <p>é»’(ã‚ãªãŸ): <span id="s-black">2</span> ç™½(ç›¸æ‰‹): <span id="s-white">2</span></p>
        <div id="game-over" class="hidden">
            <h2 id="win-msg"></h2>
            <button id="btn-retry">å†åº¦å¯¾æˆ¦</button>
            <button class="back-btn">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
        </div>
    </div>

    <div id="screen-settings" class="screen hidden">
        <h2>è¨­å®š</h2>
        <p>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ : <input type="text" id="setting-nick" maxlength="10"></p>
        <p>åŠ¹æœéŸ³: <button id="btn-sound">ON</button></p>
        <p>ç›¤é¢ã®è‰²: <input type="color" id="color-picker" value="#27ae60"></p>
        <button id="btn-save-settings">ä¿å­˜ã—ã¦æˆ»ã‚‹</button>
    </div>

    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getDatabase, ref, set, onValue, update, remove, push } from "firebase/database";

        // å›ã®Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBYb9uXyjA7XJdRiYjcA3VBlSVgLh0C1fw",
            authDomain: "hrmk-othello.firebaseapp.com",
            projectId: "hrmk-othello",
            storageBucket: "hrmk-othello.firebasestorage.app",
            messagingSenderId: "91127278693",
            appId: "1:91127278693:web:89d6cdbbcabac60a172a8c",
            databaseURL: "https://hrmk-othello-default-rtdb.firebaseio.com" // æ‰‹å‹•è¿½åŠ 
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- å¤‰æ•°ç®¡ç† ---
        let myNick = "";
        let soundOn = true;
        let myRole = "black"; // black or white
        let currentTurn = "black";
        let roomID = null;
        let isOnline = false;
        let cpuLevel = null;
        let boardState = Array(64).fill(null); // null, 'black', 'white'

        // --- ç”»é¢é·ç§» ---
        const show = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };

        document.getElementById('nick-btn').onclick = () => {
            myNick = document.getElementById('nick-input').value || "ãªãªã—";
            document.getElementById('name-display').innerText = myNick;
            document.getElementById('setting-nick').value = myNick;
            show('screen-menu');
        };

        document.getElementById('btn-cpu-menu').onclick = () => show('screen-cpu-lv');
        document.getElementById('btn-online-menu').onclick = () => show('screen-online');
        document.getElementById('btn-settings-menu').onclick = () => show('screen-settings');
        document.querySelectorAll('.back-btn').forEach(b => b.onclick = () => {
            if(roomID && isOnline) remove(ref(db, 'rooms/' + roomID));
            isOnline = false;
            show('screen-menu');
        });

        // --- è¨­å®š ---
        document.getElementById('btn-save-settings').onclick = () => {
            myNick = document.getElementById('setting-nick').value;
            document.getElementById('name-display').innerText = myNick;
            document.documentElement.style.setProperty('--board-color', document.getElementById('color-picker').value);
            show('screen-menu');
        };

        // --- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒƒãƒãƒ³ã‚° ---
        document.getElementById('btn-create-room').onclick = () => {
            roomID = Math.random().toString(36).substring(2, 7).toUpperCase();
            set(ref(db, 'rooms/' + roomID), {
                host: myNick,
                status: 'waiting'
            });
            document.getElementById('online-status').innerText = "éƒ¨å±‹ã‚³ãƒ¼ãƒ‰: " + roomID + "\nå¾…æ©Ÿä¸­...";
            
            onValue(ref(db, 'rooms/' + roomID), (snapshot) => {
                const data = snapshot.val();
                if(data && data.status === 'matched') {
                    alert("ãƒãƒƒãƒãƒ³ã‚°ã—ã¾ã—ãŸï¼ç›¸æ‰‹: " + data.guest);
                    isOnline = true;
                    myRole = "host"; 
                    startJanken();
                }
            });
        };

        document.getElementById('btn-join-room').onclick = () => {
            const code = document.getElementById('room-input').value.toUpperCase();
            const roomRef = ref(db, 'rooms/' + code);
            update(roomRef, {
                guest: myNick,
                status: 'matched'
            }).then(() => {
                roomID = code;
                isOnline = true;
                myRole = "guest";
                startJanken();
            });
        };

        // --- ã˜ã‚ƒã‚“ã‘ã‚“ (ç°¡æ˜“åŒæœŸç‰ˆ) ---
        function startJanken() {
            show('screen-janken');
        }
        window.sendJanken = (hand) => {
            const path = `rooms/${roomID}/janken/${myRole}`;
            set(ref(db, path), hand);
            document.getElementById('janken-msg').innerText = "ç›¸æ‰‹ã®é¸æŠã‚’å¾…ã£ã¦ã„ã¾ã™...";
            
            onValue(ref(db, `rooms/${roomID}/janken`), (snap) => {
                const hands = snap.val();
                if(hands && hands.host && hands.guest) {
                    // ã“ã“ã§å‹æ•—åˆ¤å®šã—ã¦ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆä»Šå›ã¯ãƒ›ã‚¹ãƒˆå…ˆæ”»å›ºå®šã®ç°¡æ˜“ç‰ˆï¼‰
                    setTimeout(() => startGame('online'), 1000);
                }
            });
        };

        // --- ã‚²ãƒ¼ãƒ æœ¬ä½“ ---
        window.startGame = (mode, lv) => {
            show('screen-game');
            cpuLevel = lv;
            initBoard();
        };

        function initBoard() {
            boardState = Array(64).fill(null);
            boardState[27] = 'white'; boardState[28] = 'black';
            boardState[35] = 'black'; boardState[36] = 'white';
            renderBoard();
        }

        function renderBoard() {
            const b = document.getElementById('board');
            b.innerHTML = "";
            let bCount = 0, wCount = 0;
            boardState.forEach((s, i) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                if(s) {
                    const stone = document.createElement('div');
                    stone.className = `stone ${s}`;
                    cell.appendChild(stone);
                    if(s==='black') bCount++; else wCount++;
                }
                cell.onclick = () => handleMove(i);
                b.appendChild(cell);
            });
            document.getElementById('s-black').innerText = bCount;
            document.getElementById('s-white').innerText = wCount;
        }

        function handleMove(idx) {
            if(boardState[idx]) return;
            // æœ¬æ¥ã¯ã“ã“ã§ã‚ªã‚»ãƒ­ã®ãƒ«ãƒ¼ãƒ«åˆ¤å®šï¼ˆæŒŸã‚ã‚‹ã‹ï¼‰ã‚’å…¥ã‚Œã‚‹
            boardState[idx] = currentTurn;
            currentTurn = currentTurn === 'black' ? 'white' : 'black';
            renderBoard();
            if(cpuLevel && currentTurn === 'white') setTimeout(cpuMove, 1000);
        }

        function cpuMove() {
            const emptyIdx = boardState.map((s, i) => s === null ? i : null).filter(i => i !== null);
            if(emptyIdx.length > 0) {
                const move = emptyIdx[Math.floor(Math.random() * emptyIdx.length)];
                handleMove(move);
            }
        }

    </script>
</body>
</html>
